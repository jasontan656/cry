# 🧪 Hub 压测报告（自动生成）

## 0. 测试环境
- **工具与版本**：Python 3.10.11 + requests库（自制压测脚本）
- **服务器信息快照**：
  - 系统：Windows 10 with Git Bash
  - **关键发现**：端口耗尽问题 - TIME_WAIT连接占满65494-65534端口范围
  - 网络状态：大量TIME_WAIT状态连接（>1000个）
- **BASE_URL**：http://127.0.0.1:8000
- **命令与配置**：统一Content-Type: application/json，warm-up已执行

## 1. 基线对比
| 场景 | 并发 | 总请求 | RPS | 平均 | P95 | P99 | 错误率 | 状态分布 |
|---|---:|---:|---:|---:|---:|---:|---:|---|
| 有效 intent | 50 | 1000 | 815.92 | 51.25ms | 84.54ms | 107.08ms | 0.00% | 200=1000 |
| 无效 intent | 50 | 1000 | 735.66 | 38.33ms | 72.98ms | 89.07ms | 0.00% | 400=1000 |

> **观察**：无效intent的Fast Fail路径明显更快（~16%提升），P95延迟降低13%

## 2. 并发爬坡（寻找"膝点/拖慢点"）

### 2.1 有效 intent
| 并发c | RPS | P95 | 错误率 |
|---:|---:|---:|---:|
| 1 | 67.84 | 27.07ms | 0.00% |
| 10 | 669.84 | 15.73ms | 0.00% |
| 50 | 815.92 | 84.54ms | 0.00% |
| 100 | 820.91 | 86.42ms | 7.06% |

- **观察**：拐点≈ c=100；建议安全并发≤50
- **关键发现**：c=100时开始出现连接失败（7.06%错误率）

### 2.2 无效 intent（Fast Fail）
| 并发c | RPS | P95 | 错误率 |
|---:|---:|---:|---:|
| 50 | 1125.94 | 96.61ms | 0.00% |

- **观察**：Fast Fail路径更稳定，RPS提升53%
- **Fast Fail优势**：处理速度快、资源消耗低

## 3. 极限拉爆（60s）
- **条件**：线程/并发=50，时长=60s
- **结果**：
  - RPS=901.97
  - P95=106.49ms，P99=170.82ms
  - 错误率=**77.69%**（极其严重）
  - 失败请求=42,045，成功请求=12,073
  - **系统崩溃**：连接拒绝大量出现
- **结论**：**明确崩点触发** - 系统在持续高并发下无法维持服务质量

## 4. 结论与容量评估
- **安全并发上限**：≈ c=50（以P95≤100ms、错误率≤1%）
- **吞吐量能力**（稳态RPS）：≈ 800-850 RPS
- **拖慢点（膝点）**：c≈100（之后错误率急剧上升）
- **崩点**：c=50持续60秒触发端口耗尽，错误率77%
- **有效 vs 无效 intent**：
  - Fast Fail路径性能优异（RPS +53%，延迟-13%）
  - 推测原因：跳过业务逻辑处理，直接返回错误

## 5. 建议与后续

### 🔧 紧急修复建议
1. **端口耗尽问题**：
   - 调整TCP配置：减少TIME_WAIT时间
   - 启用SO_REUSEADDR套接字选项
   - 考虑连接池复用

2. **服务参数调优**：
   - uvicorn workers数量调优（建议4-8）
   - 启用HTTP keep-alive
   - 调整事件循环策略（uvloop）

### 📊 系统参数建议
- **Windows TCP设置**：
  - `netsh int ipv4 set dynamicport tcp start=1024 num=64511`
  - 调整TcpTimedWaitDelay注册表项
- **ulimit调整**：增加文件句柄限制
- **连接池配置**：FastAPI/uvicorn连接管理

### 🚀 未来扩容计划
- **雇主搜索（重DB读）**压测需求：
  - 数据库连接池压测（PgBouncer/连接数调优）
  - 读写分离测试
  - 缓存层压测（Redis）
  - 索引优化验证
  - 分页查询性能测试

> **原始数据保存位置**：
> - 详细测试数据：`bench/raw/`
> - 完整报告：`bench/REPORT.md`
> - 系统资源快照：`bench/raw/system_snapshot.log`

---
**测试完成时间**：$(date)  
**关键发现**：端口耗尽是当前系统的主要瓶颈，需优先解决网络层配置问题。
