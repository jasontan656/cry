# Career Planning Bot 完整设计说明文档

## 目标
通过详细的问答记录，构建完整的网站交互流程说明，用于自动补全所有模块的：
- 依赖关系待补: 模块间协作关系的明确定义
- 业务规则待补: 业务逻辑决策点的处理策略

## 问答记录

### 问题轮次 1

**AI提问：**
基于您提供的对话流程，我需要了解以下3个核心问题：

1. **用户身份切换机制**：当用户在"求职者"和"招聘方"身份之间切换时，前端如何处理状态保持？是否需要重新登录，还是同一账户可以同时拥有两种身份？

2. **MBTI测试外链返回机制**：用户点击外链 https://www.topwyc.com/mbti 完成测试后，如何返回到我们的系统？是通过回调URL、用户手动输入结果，还是其他方式？

3. **文件上传的并发处理**：当用户上传简历文件时，如果文件较大或网络较慢，用户是否可以继续其他操作，还是必须等待上传完成？

**用户回答（原话）：**
1. 我的理想设计是，用户初次注册是没有状态的，用户注册后，可以点击网站上的 "I want find job" 或者 "I want to hire" ，此2个button是预设置在聊天窗口中的，用户也可以直接发送任意消息来触发流程（因为后端的entryagent本身会拒绝无关意图），此时如果用户未注册，则会直接触发注册流程，如果用户已经注册了，发消息可能导致意图不符，点击招聘或者求职流程时触发下一步的流程，如果是招聘，则首先触发预设提示词""Hello, I am the career bot. I have many powerful abilities, but they are currently under development. Whether you want to find a job or take a test, you just need to follow the process and complete our conversation to finish the test and see your summary results. Please rest assured that the testing process does not require any of your sensitive information. Only when you finally decide to upload your resume and register your personal information will we obtain and store your personal information to match you with suitable jobs and employers. We use a very powerful matching method to find you the job closest to your residence and best suited to your talents and experience. Now let's start the testing process. First, please provide your MBTI test result. If you haven't taken the test yet, please use the link below."
Button: [Take the MBTI Test](https://www.topwyc.com/mbti)
"" 此时用户可以选择点击连接，用连接表单完成测试，点击提交按钮则会自动返回给bot结果，此时bot输出关于这个MBTI结果的测试结果的说明，并且接着根据MBTI反向测试的规则，输出12道反向测试的题目，每个唯独3道题，也会生成一个表单，让用户进行选择（此为确保字段正确，避开使用大模型进行语义判断），用户选择后，我们输出预设的拼接结果，""bot output: "Thank you for submitting your MBTI test result. To further complete your profile, please complete a short reverse-dimension test. We will generate 4 sets of test questions based on your MBTI type, each corresponding to one dimension of the MBTI. Please click the button below to go to the assessment page, select your answers, and submit them with one click."
""接着用户就需要提供出生年月日，再次触发ninetestagent的规则对其出生年月进行分析，并且 按照预设规则输出测试结果，输出完成之后，联动finalanalysisoutputagent，对前两次的结果进行综合分析，输出报告给客户。 前面过程中，客户提供的所有内容会分两类存储，1. 直接的结果存储 如INTJ（作为用户画像，同时作为聊天记录），以及bot输出的分析报告（作为用户画像，同时作为聊天记录存储）。然后接着由用户选择是否要继续上传简历，以及多轮对话补足简历缺失的内容，在完成本轮后，也会对用户所有字段进行存储，然后由finalanalysisoutputagent再次结合 3，4，步骤的所有内容，进行生成分析报告，自动进行输出，至此用户的初步画像内容收集结束，用户的求职者身份激活。 这个激活状态会是常驻的，只要激活一次，那么就一直会处于激活状态，但是是否可以被雇主搜索到，则取决于我们的另外设置的规则（每次被购买会冷却3天，总计简历可被购买10次则会下架它的简历，如果需要激活，则需要再次登入网站，点击我要求职，则会再次上架）。   用户此时如果也去点击我要招聘，并且完成流程后，则会激活雇主身份，此时这个身份也是常驻的，用户此时需要上传招聘简章，让系统知道用什么内容去匹配（此时系统已经完成了对公司资料和招聘简章的打标），那么此时用户就可以点击第一个上传的job，依据此job进行数据库匹配检索，每次最多输出2份简历，并且搜索到的简历会记录进历史记录，如果用户继续搜索，则会出现新的简历，优先级根据匹配度从高到低输出，所以相当于用户每次点击匹配的时候，之前已经搜索到的用户id需要对这个用户的搜索记录进行存储，直到此被搜索用户下架为止（为了防止重复搜索到同一个已经搜索到的用户，是一个过滤机制，这个机制似乎我还未写入开发文档，需要注意），综上所述，用户实际上可以拥有两种状态，但是这并不是真正的状态，而是因为点击了不同的按钮，激活了不同的功能，从而使用不同的功能。 网站的两大功能和传统的招聘网站是不太一样的，找工作的时候不需要主动搜索，被搜索的时候也是企业主直接搜索到简历，看完整的画像，然后直接进行挑选，如果满意，则用预购点数直接购买简历，从而看到联系方式，可以直接联系求职者预约面试。此时已经完全可以跳过prescreening，因为我们已经帮雇主收集好了所有的信息，分析报告等。

2. 已经回答。 

3. 上传本身限制5m，过大它上传不了，会要求它重新选择文件上传。

**提取的关键信息：**

#### 模块依赖关系分析：
- **entry_agent** → **routing_agent** → **auth_agent** (身份验证)
- **求职流程链**：entry_agent → mbti_followup_agent → ninetest_agent → final_analysis_output_agent → resume_agent → database_agent
- **招聘流程链**：entry_agent → company_identity_agent → jobpost_agent → matching_agent → database_agent
- **标签系统**：taggings_agent 贯穿整个流程，为所有数据打标
- **前端交互**：frontend_service_agent 处理所有UI状态和表单

#### 前端行为节点：
1. **按钮点击**：预设按钮"I want find job"/"I want to hire"触发不同流程
2. **外链跳转**：MBTI测试链接跳转到外部表单，完成后自动返回结果
3. **表单生成**：12道反向测试题目动态生成表单界面
4. **文件上传**：5MB限制，超出显示重选提示
5. **状态显示**：双身份激活状态在UI中持久显示

#### 后端触发链：
1. **意图识别**：entry_agent拒绝无关意图，路由到对应agent
2. **身份激活**：完成流程后permanent激活求职者/雇主身份
3. **数据存储**：双重存储机制（用户画像+聊天记录）
4. **搜索过滤**：matching_agent维护搜索历史，防止重复推荐
5. **冷却机制**：购买后3天冷却，10次购买后自动下架

#### 重大决策点：
1. **身份激活策略**：一次激活永久有效 vs 需要定期重新激活
2. **搜索历史范围**：按雇主+职位维度存储 vs 全局存储
3. **下架重激活流程**：重新完整测试 vs 简化确认流程
4. **点数消耗规则**：每份简历固定点数 vs 动态定价
5. **数据存储策略**：画像数据与聊天记录的同步机制

### 问题轮次 2

**AI提问：**
1. **搜索历史存储机制**：您提到"之前已经搜索到的用户id需要对这个用户的搜索记录进行存储"，这个存储是按照雇主+职位维度吗？比如同一个雇主的不同职位是否共享搜索历史，还是每个职位独立维护搜索历史？

2. **简历下架后的重新激活流程**：当求职者简历被购买10次下架后，重新点击"我要求职"是否需要重新完成整个测试流程（MBTI+反向测试+出生日期+简历上传），还是只需要确认重新上架即可？

3. **预购点数系统**：您提到雇主用"预购点数"购买简历，这个点数系统是如何运作的？雇主如何充值点数，每份简历消耗多少点数，点数不足时如何处理？

**用户回答（原话）：**
1. 这个存储是按照雇主+职位纬度，也就是说，不同的职位，如果这个求职者符合标准，那么就可以再次搜索到，但是同一职位则不会再次搜索到（除非这个用户已经出现了下架再上架的情况）。 

2. 不需要再次完成整个流程，只要点击就再次激活（之前下架的信息是次数达到之后，邮件通知用户， 并且自动下架，此时用户如果还没找到工作，则会上线再次激活，继续让雇主可以搜索到） 

3. 雇主需要线下支付费用，由我们在系统后台手动添加点数到这个雇主账户。 每份简历消耗1个点数，最少一次性购买10个点数，点数不足购买失败，提醒用户需要再次购买。

**提取的关键信息：**

#### 新增模块依赖关系：
- **matching_agent** ↔ **database_agent**：搜索历史按(雇主ID+职位ID)维度存储和查询
- **mail_agent** ← **database_agent**：达到10次购买限制时触发邮件通知
- **点数管理系统**：需要新增模块处理线下支付和后台点数管理

#### 新增前端行为节点：
1. **搜索结果展示**：同一职位不显示已搜索过的简历（除非重新上架）
2. **下架通知**：用户收到邮件通知后，前端显示重新激活按钮
3. **点数不足提醒**：购买失败时显示"点数不足，请联系客服充值"提示
4. **一键重新激活**：下架用户点击"我要求职"直接重新上架，无需重新测试

#### 新增后端触发链：
1. **购买计数**：每次购买后database_agent更新计数，达到10次触发下架+邮件通知
2. **搜索过滤逻辑**：matching_agent查询时排除已搜索的(雇主+职位+求职者)组合
3. **重新上架机制**：下架用户重新激活时重置购买计数，清空相关搜索历史
4. **点数验证**：购买前验证雇主账户点数，不足则阻止购买并提示



### 问题轮次 3

**AI提问：**
1. **3天冷却期的具体机制**：您之前提到"每次被购买会冷却3天"，这个冷却期是指求职者在被购买后3天内不会出现在任何雇主的搜索结果中，还是只是不会出现在购买过该求职者的雇主的搜索结果中？

2. **公司验证与职位发布的关联**：雇主完成公司验证后，是否可以立即发布职位并开始搜索，还是需要等待审核？如果一个雇主有多个公司验证通过，发布职位时如何选择以哪个公司名义发布？

3. **标签系统的触发时机**：taggings_agent在什么时候为数据打标？是在用户提交MBTI结果时、上传简历时、还是在每个步骤都会实时打标？雇主的公司资料和职位描述的打标时机又是如何？

**用户回答（原话）：**
1. 3天冷却目前确定为不会出现在任何搜索中，因为既然雇主花钱购买了简历，那么可预见的应该是会立刻联系，预约面试，所以暂时我们并不希望别人可以搜索到他的简历，逼迫这个用户去参加面试否则就只能继续等待，这个冷却更改一下吧，每被购买2次，暂停可被搜索3天，这个机制应该是认为被暂停，而不是彻底下架，定义要区分开。

2. AI验证信息正确后，就可以立刻发布职位开始搜索，不需要等待审核，用户有多个公司验证成功，此时需要经过机器人的对话流程，选择指定公司，选择指定招聘简章，开始搜索，也可以上传新的 招聘简章用以匹配，每个上传的招聘简章，都会存入这个公司内，也就是一个用户可以有多个公司，每个公司可以有多个职位

**提取的关键信息：**

#### 修正的模块依赖关系：
- **冷却机制修正**：每2次购买触发3天暂停（非下架），10次购买才真正下架
- **多公司管理**：company_identity_agent需要支持用户多公司切换选择
- **职位管理层级**：用户 → 多个公司 → 每个公司多个职位的三层结构

#### 修正的前端行为节点：
1. **暂停vs下架状态区分**：UI需要显示不同的状态标识和操作按钮
2. **公司选择流程**：多公司用户需要先选择公司，再选择/上传职位
3. **即时搜索**：验证通过后立即可用，无需等待审核

#### 修正的后端触发链：
1. **暂停计数机制**：database_agent维护购买计数，每2次触发暂停，每10次触发下架
2. **公司职位关联**：jobpost_agent需要按公司维度管理职位库
3. **实时验证**：company_identity_agent验证通过后立即激活搜索功能



### 问题轮次 4

**AI提问：**
1. **标签系统的触发时机**：taggings_agent在什么时候为数据打标？是在用户提交MBTI结果时、上传简历时、还是在每个步骤都会实时打标？雇主的公司资料和职位描述的打标时机又是如何？

2. **暂停期间的用户通知机制**：当求职者因为被购买2次而进入3天暂停期时，系统是否会通知用户当前状态？用户是否可以查看自己的暂停剩余时间和被购买历史？

3. **多公司操作的并发限制**：一个雇主如果验证了多个公司，是否可以同时为不同公司进行搜索操作，还是必须选择一个公司后才能进行搜索，搜索完毕后再切换到另一个公司？

**用户回答（原话）：**
1. 标签系统仅在收集完善时触发，用户方面的话，需要完成核心业务5步骤，此时才有足够的信息去打标，公司用户的话，会多次触发打标，公司文件上传完成后，会打标，上传招聘简章，会依据公司资料+招聘简章，给这个招聘简章打标（此时则可用以匹配），再上传招聘简章，会再次触发打标，这样每个招聘简章都有足够的标签用以匹配，所以用户一个账户下，会分为用户id，然后自画像存储各个集合，和公司存储，公司1，公司2，然后公司1-招聘1，招聘2，招聘3，这样的嵌套存储方式。

2. 暂停期间我们不会通知用户。 用户无感知。

3. 必须选择一个公司，再选择一个特定的招聘简章，然后才能激活搜索。 搜索完毕再切换到另一个简历，或者另一个公司，上述流程都是通过对话完成，而不是传统的按按钮等。（实际上是在对话框中按按钮，就是我们全部的流程都是由对话来触发的，并不是传统的自己去找按钮，此时如果你不去走这个对话流程的话，则无法触发这些功能，后续我们会加入对话意图的判断，客服机器人的东西，此时用户才可以真正的对话，比如咨询，或者直接打字说明，我想要为xxx公司的某职位搜索简历，此时机器人则会直接跳转到对应步骤，而不是强制要求用户点击。

**提取的关键信息：**

#### 标签系统完整机制：
- **求职者打标**：完成5步骤后一次性打标（MBTI+反向测试+出生日期+简历+补充信息）
- **雇主打标**：多次触发 - 公司文件上传后打标，每次招聘简章上传都会结合公司资料重新打标
- **数据存储结构**：用户ID → {个人画像集合, 公司1{招聘1,招聘2,招聘3}, 公司2{招聘1,招聘2}}

#### 对话驱动的交互模式：
- **当前阶段**：所有操作通过对话框内按钮触发，必须遵循对话流程
- **未来升级**：增加意图识别，支持自然语言直接跳转功能
- **操作限制**：必须单公司单职位操作，不支持并发搜索

#### 无感知暂停机制：
- **用户体验**：暂停期间用户完全无感知，不显示状态和剩余时间
- **后台处理**：matching_agent静默过滤暂停用户，不出现在搜索结果中

### 问题轮次 5 - 重大决策点确认

**AI提问：**
需要您决策的11个重大问题（涵盖搜索历史、通知机制、权限管理、匹配算法、容错处理等）

**用户回答（原话）：**
1. 用户重新上架时，并不会清空搜索记录，因为搜索了却没买，那就是看不上，不需要再次出现在雇主的搜索中，但是当用户升级了自己的简历有更新时，才会重置该用户的搜索记录，可再次出现在以前已经搜索过他的雇主搜索中，并且从历史记录中移除。（这个也是后续的升级功能，用户将需要支付费用来更新他的简历，这个并不是免费的，但是并不包括在本次开发内容中。

2. 不需要提前预警

3. 后台只有一个admin账户，全权由我操作，后续会改为自动化，用户在线购买后直接添加点数，目前由于没有支付渠道，所以暂时手动。

4. 暂停期间不通知

5. 必须单公司操作，因为一个求职者最终坐什么职位是由公司决定的，搜索只是用什么"质量"去匹配，但是用户最终入职后的职位则完全由公司在面试后决定。

6. 不可复用，必须重新再次上传分析。

7. 重新打标，因为信息已经不一致。

8. 未来的事情未来再说。

9. 中途退出时对话状态完全保留，下次回来或者下次点击对应流程，依然是原本的对话状态不会因为退出就重置。

10. 这个是由向量数据库的语义近似度来匹配的，从而直接实现了匹配度高低的排序。最高匹配度最优先显示，继续搜索则继续显示其次。

11. 出现故障直接报错，需要修复，没有降级策略。

**确认的重大决策：**

#### 搜索历史管理策略：
- **重新上架**：保持原有搜索记录，不清空
- **简历更新**：付费更新简历时重置搜索记录，可重新出现在历史雇主搜索中
- **未来功能**：付费简历更新（当前版本不包含）

#### 通知和权限管理：
- **预警机制**：无需8次、9次购买预警
- **暂停通知**：暂停期间不通知用户
- **后台权限**：单一admin账户手动管理，未来升级为自动化支付

#### 操作限制和复用策略：
- **公司操作**：必须单公司单职位操作
- **职位复用**：不同公司间职位描述不可复用，必须重新上传
- **标签更新**：信息更新时重新打标

#### 技术实现策略：
- **对话状态**：完全持久化，退出后状态保留
- **匹配算法**：基于向量数据库语义近似度排序
- **容错处理**：无降级策略，故障时直接报错



