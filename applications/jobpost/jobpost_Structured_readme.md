# jobpost_agent 结构化文档骨架

# 字段迁移说明
```
所有数据模型/Schema已迁移至global_schemas.json，由routing_agent动态生成和分发：
- ContextData模型 - context.data通信字段（包含entity_id、entity_type、operation、text_input等）已迁移
- ProcessingResult模型 - 职位处理结果通用结构已迁移至global_schemas.json
- FileRecord模型 - 文件记录和上传相关字段已迁移至global_schemas.json
- CompanyProfile模型 - 企业信息结构已迁移至global_schemas.json

所有配置参数已迁移至global_config.json：
- jobpost_agent配置组包含processing_config、validation_rules、file_upload_config等
```

## A: 开发边界与职责说明

### A-1: 模块基本定义
```
jobpost_agent是Career Bot系统的职位信息处理中心，负责处理职位信息解析和管理相关功能。该模块专门解析、分析和处理来自各种来源的职位信息，将非结构化的职位描述提取为结构化数据，并进行标准化处理以支持匹配和分析。
```

------------------------------

### A-2: 核心功能特性
```
├── A-2.1: 多格式职位信息处理
│   ├── A-2.1.1: 多源输入支持 - 支持文本输入和文件上传（PDF、DOCX、TXT、图像等）
│   ├── A-2.1.2: 智能文本提取 - 自动从各种文档格式中提取职位信息
│   ├── A-2.1.3: 内容整合 - 将多个文件的内容合并为完整的职位信息
│   └── A-2.1.4: 格式标准化 - 统一处理不同来源的职位信息格式
├── A-2.2: 智能分析与验证
│   ├── A-2.2.1: 完整性检查 - 基于预定义字段要求验证职位信息完整性
│   ├── A-2.2.2: 内容优化 - 使用AI技术优化职位描述，使其更吸引候选人
│   ├── A-2.2.3: 结构化提取 - 提取关键信息用于后续标签生成和匹配
│   └── A-2.2.4: 质量控制 - 确保职位信息的准确性和专业性
└── A-2.3: 双路径处理机制
    ├── A-2.3.1: 不完整路径 - 识别缺失字段，生成具体的补充问题列表
    ├── A-2.3.2: 完整路径 - 优化职位信息描述，提取结构化标签数据
    ├── A-2.3.3: 动态反馈 - 提供字段状态详情和精确的完整性反馈
    └── A-2.3.4: 循环改进 - 支持多轮优化直到职位信息完整
```

------------------------------

### A-3: 模块接入说明
```
jobpost_agent是被动调用的业务模块，不包含启动逻辑和测试代码。整个Career Bot系统的启动入口统一在boot/目录中：
- 系统启动：使用python main.py --start从boot/启动整个系统
- 模块装配：通过boot/launcher.py基于applications/__registry__.py装配
- 服务调用：启动后通过routing_agent进行统一调度
- 功能测试：测试逻辑已迁移至utility_tools/global_test/进行独立管理
```

------------------------------

## B: 模块依赖关系

### B-1: 上游触发
```
├── B-1.1: routing_agent - 唯一任务调度来源，提供职位处理任务分发和配置管理
├── B-1.2: company_identity_agent - 企业验证完成后，用户选择特定企业触发职位创建
├── B-1.3: frontend_service_agent - 用户上传职位文档或输入职位信息后触发处理
└── B-1.4: database_agent - 职位信息更新时触发重新处理和标签更新
```

------------------------------

### B-2: 下游调用
```
├── B-2.1: llm_handler_agent - 职位信息智能分析、内容优化和结构化提取
├── B-2.2: database_agent - 职位数据存储、企业-职位关联管理和版本控制
├── B-2.3: taggings_agent - 每次职位上传时触发该职位的专项打标
└── B-2.4: matching_agent - 提供完整职位信息用于候选人匹配
```

------------------------------

### B-3: 数据约束
```
├── B-3.1: 企业关联强制 - 职位必须关联到用户已验证的特定企业
├── B-3.2: 字段完整性验证 - 基于预定义字段要求验证职位信息完整性
├── B-3.3: 多轮优化支持 - 支持职位信息的多轮完善和优化
└── B-3.4: 版本管理 - 职位修改后保留历史版本便于追踪变更
```

------------------------------

### B-4: 过滤去重历史维度
```
├── B-4.1: 企业维度组织 - 按用户选择的当前企业维度组织和管理职位
├── B-4.2: 职位去重 - 基于职位标题和企业ID避免重复创建相同职位
├── B-4.3: 历史版本 - 保留职位信息修改历史，支持版本对比和回滚
└── B-4.4: 状态跟踪 - 跟踪职位从创建到发布的完整状态转换
```

------------------------------

### B-5: 并发顺序性
```
├── B-5.1: 企业选择优先 - 必须先选择企业，再进行职位创建或修改
├── B-5.2: 字段验证顺序 - 按必填字段优先级顺序进行验证和提示
└── B-5.3: 打标异步触发 - 职位上传完成后异步触发taggings_agent打标
```

------------------------------

## C: 重大决策与策略

### C-1: 企业维度管理策略
```
├── C-1.1: 单企业单职位 - 用户必须先选择特定企业，再创建该企业的职位信息
├── C-1.2: 企业验证前置 - 只有验证通过的企业才能创建职位信息，确保合规性
├── C-1.3: 企业切换支持 - 用户可以在不同验证企业间切换并管理对应职位信息
└── C-1.4: 职位信息归属明确 - 每个职位信息明确归属于特定企业，便于权限和搜索管理
```

------------------------------

### C-2: 职位信息处理策略
```
├── C-2.1: 多格式智能处理 - 支持文本、PDF、DOCX、图像等多种格式输入
├── C-2.2: 双路径处理机制 - 完整职位信息直接优化，不完整职位信息引导补充
├── C-2.3: 循环改进模式 - 支持多轮优化直到职位信息达到发布标准
└── C-2.4: 质量控制严格 - 基于预定义字段要求确保职位信息完整性
```

------------------------------

### C-3: 打标触发策略
```
├── C-3.1: 每次上传打标 - 每次职位信息上传都触发taggings_agent重新打标
├── C-3.2: 企业信息结合 - 职位信息打标时结合对应企业的基础信息进行综合标签生成
├── C-3.3: 标签版本管理 - 职位信息修改后重新生成标签，保留历史标签版本
└── C-3.4: 异步处理 - 打标过程异步进行，不影响用户的职位信息编辑流程
```

------------------------------

### C-4: 对话驱动策略
```
├── C-4.1: 即时反馈 - 职位信息处理结果立即在聊天界面反馈给用户
├── C-4.2: 问题引导 - 信息不完整时生成具体的补充问题清单
├── C-4.3: 状态透明 - 实时显示职位信息完整性状态和缺失字段信息
└── C-4.4: 流程友好 - 支持用户随时中断和继续职位信息创建流程
```

------------------------------

## D: 合约与字段变更

### D-1: 职位状态管理字段
```
├── D-1.1: 职位信息状态枚举
│   ├── D-1.1.1: DRAFT - 草稿状态，信息不完整
│   ├── D-1.1.2: COMPLETE - 信息完整，待发布
│   ├── D-1.1.3: PUBLISHED - 已发布，可被搜索
│   ├── D-1.1.4: PAUSED - 暂停招聘
│   ├── D-1.1.5: CLOSED - 招聘结束
│   └── D-1.1.6: ARCHIVED - 已归档
└── D-1.2: 处理状态字段
    ├── D-1.2.1: processing_status - 当前处理状态
    ├── D-1.2.2: completeness_score - 完整性评分（0-100）
    ├── D-1.2.3: missing_fields - 缺失字段列表
    └── D-1.2.4: last_updated - 最后更新时间戳
```

------------------------------

### D-2: 企业关联字段
```
├── D-2.1: 企业关联字段
│   ├── D-2.1.1: company_id - 关联企业ID（必填）
│   ├── D-2.1.2: company_name - 企业名称（冗余存储便于查询）
│   ├── D-2.1.3: company_verification_status - 企业验证状态
│   └── D-2.1.4: user_company_role - 用户在该企业的角色权限
└── D-2.2: 职位归属字段
    ├── D-2.2.1: created_by_user_id - 创建用户ID
    ├── D-2.2.2: managed_by_users - 可管理该职位的用户列表
    └── D-2.2.3: company_department - 所属部门（可选）
```

------------------------------

### D-3: 职位字段验证配置
```
├── D-3.1: 必填字段配置
│   ├── D-3.1.1: required_fields_list - 必填字段清单
│   ├── D-3.1.2: field_validation_rules - 各字段验证规则
│   ├── D-3.1.3: completeness_threshold - 完整性发布阈值
│   └── D-3.1.4: quality_check_enabled - 质量检查开关
└── D-3.2: 字段模板配置
    ├── D-3.2.1: job_title_templates - 职位标题模板库
    ├── D-3.2.2: description_optimization_rules - 描述优化规则
    └── D-3.2.3: salary_format_standards - 薪资格式标准
```

------------------------------

### D-4: 职位处理错误码
```
├── D-4.1: 统一错误码格式
│   ├── D-4.1.1: JOBPOST/COMPANY_NOT_SELECTED - 未选择企业
│   ├── D-4.1.2: JOBPOST/COMPANY_NOT_VERIFIED - 企业未验证
│   ├── D-4.1.3: JOBPOST/INCOMPLETE_FIELDS - 字段信息不完整
│   ├── D-4.1.4: JOBPOST/INVALID_FORMAT - 职位信息格式无效
│   └── D-4.1.5: JOBPOST/DUPLICATE_TITLE - 重复职位信息标题
└── D-4.2: 企业关联错误码
    ├── D-4.2.1: JOBPOST/COMPANY_ACCESS_DENIED - 企业访问权限不足
    ├── D-4.2.2: JOBPOST/COMPANY_MISMATCH - 企业信息不匹配
    └── D-4.2.3: JOBPOST/MAX_JOBS_EXCEEDED - 超出职位信息创建上限
```

------------------------------

### D-5: 受影响的上下游字段联动
```
├── D-5.1: company_identity_agent - 企业验证状态和选择状态需传递到职位创建
├── D-5.2: taggings_agent - 职位上传完成触发需传递企业信息和职位内容
├── D-5.3: database_agent - 企业-职位关联关系和职位版本管理需同步
├── D-5.4: matching_agent - 职位发布状态和企业验证状态需用于匹配授权
├── D-5.5: auth_agent - 用户企业权限验证需与职位管理权限联动
└── D-5.6: routing_agent - 企业选择上下文和职位处理任务调度需协调
```

------------------------------

## E: 输出数据结构规范

### E-1: 预格式化输出结构
```
jobpost_agent负责输出完整的职位画像和头脑风暴分析，输出结构必须与database_agent的jobpost存储格式完全匹配，包含job_post_id、company_id、job_posting_info、job_requirements、job_description、jobpost_file、brainstorm_analysis、metadata等完整字段结构。
```

------------------------------

### E-2: 职位画像输出格式
```
├── E-2.1: 基础信息字段
│   ├── E-2.1.1: job_post_id - 职位唯一标识符
│   ├── E-2.1.2: company_id - 关联企业标识符
│   └── E-2.1.3: job_posting_info - 职位发布基础信息
├── E-2.2: 职位要求字段
│   ├── E-2.2.1: job_requirements - 职位技能和资格要求
│   ├── E-2.2.2: education_level - 学历要求
│   ├── E-2.2.3: experience_required - 工作经验要求
│   └── E-2.2.4: required_skills - 必需技能列表
├── E-2.3: 职位描述字段
│   ├── E-2.3.1: job_description - 详细职位描述
│   ├── E-2.3.2: key_responsibilities - 主要职责列表
│   ├── E-2.3.3: working_conditions - 工作环境条件
│   └── E-2.3.4: reporting_structure - 汇报关系结构
└── E-2.4: 分析增强字段
    ├── E-2.4.1: brainstorm_analysis - 深度分析和洞察
    ├── E-2.4.2: inferred_company_culture - 推断企业文化
    ├── E-2.4.3: hidden_requirements - 隐含职位要求
    └── E-2.4.4: ideal_candidate_profile - 理想候选人画像
```

------------------------------

### E-3: 输出数据校验规则
```
├── E-3.1: 必填字段校验
│   ├── E-3.1.1: position_title - 必填，职位名称不能为空
│   ├── E-3.1.2: work_location - 必填，菲律宾地理位置格式验证
│   ├── E-3.1.3: work_mode - 枚举值："remote_allowed"/"must_onsite"/"hybrid"
│   └── E-3.1.4: salary_range - 必须包含min_salary, currency字段，PHP货币验证
├── E-3.2: 格式校验规则
│   ├── E-3.2.1: experience_required - 必填，格式如"2-3 years"/"Fresh Graduate"
│   ├── E-3.2.2: required_skills - 数组，至少包含3个技能要求
│   ├── E-3.2.3: key_responsibilities - 数组，至少包含3个主要职责
│   └── E-3.2.4: processing_time - ISO8601格式UTC时间
└── E-3.3: 质量校验规则
    ├── E-3.3.1: brainstorm_analysis - 必须包含深度分析的关键洞察和隐含要求
    └── E-3.3.2: completeness_score - 完整性评分范围验证
```

------------------------------

### E-4: 原标签数据提取
```
├── E-4.1: 关键信息提取 - 职位标题、技能要求、经验水平、地点、雇佣类型
├── E-4.2: 技能识别 - 自动识别和分类职位所需的各类技能
├── E-4.3: 要求分析 - 区分硬性要求和软性要求
├── E-4.4: 匹配支持 - 生成适合后续匹配算法的结构化数据
└── E-4.5: 头脑风暴增强 - 深度分析显性和隐性要求，推断企业文化和工作环境
```

------------------------------

## F: 系统架构位置

### F-1: 架构流程图
```
企业发布职位 → entry_agent → routing_agent → [jobpost_agent]
                                               ↓
            文档处理 → 文本提取 → llm_handler_agent (AI分析)
                 ↓                    ↓
            完整性检查 ← ← ← ← ← ← ← 优化建议
                 ↓
            结构化数据 → database_agent → 标签生成
```

------------------------------

### F-2: 模块定位说明
```
jobpost_agent在Career Bot系统中处于职位信息处理的核心位置，承担从原始职位文档到结构化职位数据的完整转换流程，为后续的标签生成、匹配算法和用户体验提供高质量的数据基础。
```

------------------------------

## G: 接口契约

### G-1: 核心接口规范
```
├── G-1.1: 统一入口接口
│   ├── G-1.1.1: 方法签名 - async def run(request: AgentRequest) -> AgentResponse
│   ├── G-1.1.2: 输入参数 - request扁平化请求载荷，包含request_id、task_type、user_id、session_id、message、intent等直接字段
│   ├── G-1.1.3: 返回结果 - AgentResponse扁平化响应载荷，包含request_id、agent_name、success、timestamp、processing_status、results、error_details
│   └── G-1.1.4: 异常处理 - ValidationError、ConfigurationError、ProcessingError
└── G-1.2: 接口职责说明
    ├── G-1.2.1: 请求验证 - 验证输入参数的完整性和有效性
    ├── G-1.2.2: 任务分发 - 根据task_type分发到对应的处理逻辑
    ├── G-1.2.3: 结果封装 - 将处理结果封装为标准响应格式
    └── G-1.2.4: 错误处理 - 统一的异常捕获和错误信息返回
```

------------------------------

### G-2: 支持的任务类型
```
├── G-2.1: 核心任务类型
│   ├── G-2.1.1: job_post_processing - 职位信息处理
│   ├── G-2.1.2: analyze_job_completeness - 职位完整性分析
│   ├── G-2.1.3: optimize_job_content - 职位信息优化
│   ├── G-2.1.4: health_check - 健康检查
│   └── G-2.1.5: get_config - 配置获取
└── G-2.2: 任务处理说明
    ├── G-2.2.1: 任务路由 - 根据task_type路由到对应处理方法
    ├── G-2.2.2: 参数解析 - 从context中解析任务特定参数
    ├── G-2.2.3: 结果返回 - 返回任务特定的处理结果
    └── G-2.2.4: 状态跟踪 - 记录任务执行状态和性能指标
```

------------------------------

### G-3: 错误码规范
```
├── G-3.1: 标准错误码格式 - 使用{DOMAIN}/{REASON}命名格式
├── G-3.2: 通用错误码
│   ├── G-3.2.1: VALIDATION/INVALID_INPUT - 输入参数验证失败
│   ├── G-3.2.2: CONFIG/NOT_FOUND - 配置项不存在
│   ├── G-3.2.3: CONFIG/INVALID_FORMAT - 配置格式错误
│   ├── G-3.2.4: TIMEOUT/REQUEST_TIMEOUT - 请求处理超时
│   ├── G-3.2.5: AUTH/UNAUTHORIZED - 权限验证失败
│   └── G-3.2.6: IO/UNAVAILABLE - 外部服务不可用
└── G-3.3: 职位处理特定错误码
    ├── G-3.3.1: JOBPOST/UPLOAD_ERROR - 职位文档上传失败、文件损坏或无法读取
    ├── G-3.3.2: JOBPOST/FORMAT_UNSUPPORTED - 职位文档格式不支持或无法解析
    ├── G-3.3.3: JOBPOST/FILE_SIZE_ERROR - 职位文档过大或过小、内容为空
    ├── G-3.3.4: JOBPOST/EXTRACTION_ERROR - LLM无法从职位文档中提取关键信息
    ├── G-3.3.5: JOBPOST/CONTENT_INSUFFICIENT - 职位内容过少、信息不完整无法处理
    ├── G-3.3.6: JOBPOST/PARSING_QUALITY_LOW - 职位解析质量过低、字段提取失败
    ├── G-3.3.7: JOBPOST/FIELD_VALIDATION_ERROR - 职位信息字段验证失败或格式异常
    ├── G-3.3.8: JOBPOST/COMPLETENESS_ERROR - 职位必填字段缺失或不符合要求
    └── G-3.3.9: JOBPOST/SYSTEM_ERROR - 网络错误、LLM调用失败、服务异常等技术问题
```

------------------------------

### G-4: 配置依赖清单
```
├── G-4.1: 必需配置项 - 通过await routing_agent.get_config("jobpost_agent", config_type)获取
│   ├── G-4.1.1: basic_config - 基础配置
│   ├── G-4.1.2: timeout_config - 超时配置
│   ├── G-4.1.3: retry_config - 重试配置
│   ├── G-4.1.4: field_requirements - 字段要求配置
│   ├── G-4.1.5: document_parsing - 文档解析配置
│   ├── G-4.1.6: llm_prompts - LLM提示配置
│   └── G-4.1.7: validation_rules - 验证规则配置
└── G-4.2: 配置管理机制
    ├── G-4.2.1: 动态获取 - 运行时从routing_agent获取最新配置
    ├── G-4.2.2: 热更新支持 - 支持配置实时更新，无需重启服务
    ├── G-4.2.3: 缓存机制 - 合理缓存配置以提升性能
    └── G-4.2.4: 默认值处理 - 配置缺失时使用预定义默认值
```

------------------------------

### G-5: 依赖模块清单
```
├── G-5.1: 必须依赖
│   ├── G-5.1.1: routing_agent - 统一调度和配置管理
│   ├── G-5.1.2: global_schemas - 数据模型定义
│   ├── G-5.1.3: llm_handler_agent - LLM职位分析服务
│   ├── G-5.1.4: database_agent - 职位信息存储服务
│   └── G-5.1.5: taggings_agent - 职位标签生成服务
└── G-5.2: 依赖关系说明
    ├── G-5.2.1: 单向依赖 - 仅依赖上述模块，不被其他业务模块直接依赖
    ├── G-5.2.2: 接口调用 - 通过routing_agent统一调用其他模块
    ├── G-5.2.3: 数据模型 - 从global_schemas导入标准数据模型
    └── G-5.2.4: 服务协作 - 与其他模块通过标准接口协作
```

------------------------------

### G-6: 数据模型规范
```
├── G-6.1: 必须使用的Schema - 从global_schemas导入的标准模型
│   ├── G-6.1.1: AgentRequest - 请求载荷模型
│   ├── G-6.1.2: AgentResponse - 响应载荷模型
│   ├── G-6.1.3: JobPost - 职位信息模型
│   ├── G-6.1.4: JobRequirements - 职位要求模型
│   └── G-6.1.5: CompanyProfile - 企业档案模型
└── G-6.2: 模型使用规范
    ├── G-6.2.1: 导入规范 - 统一从global_schemas导入，禁止本地重复定义
    ├── G-6.2.2: 验证机制 - 使用model_validate()验证输入数据
    ├── G-6.2.3: 序列化规范 - 使用model_dump()序列化输出结果
    └── G-6.2.4: 字段扩展 - 需要新字段时通过global_schemas统一扩展
```

------------------------------

### G-7: 性能指标规范
```
├── G-7.1: 必须暴露的指标
│   ├── G-7.1.1: jobpost_agent_requests_total - 调用次数
│   ├── G-7.1.2: jobpost_agent_success_rate - 成功率
│   ├── G-7.1.3: jobpost_agent_duration_seconds - 时延分布
│   ├── G-7.1.4: jobpost_document_processing_success_rate - 文档处理成功率
│   ├── G-7.1.5: jobpost_llm_call_success_rate - LLM调用成功率
│   └── G-7.1.6: jobpost_completeness_check_accuracy - 字段完整性检查准确率
└── G-7.2: 指标收集机制
    ├── G-7.2.1: 实时收集 - 在关键处理节点实时收集性能数据
    ├── G-7.2.2: 标签维度 - 包含task_type、company_id、processing_stage等维度
    ├── G-7.2.3: 聚合统计 - 支持按时间窗口和维度进行聚合统计
    └── G-7.2.4: 监控告警 - 关键指标异常时触发监控告警
```

------------------------------

### G-8: 最小可执行示例
```
示例仅用于协议理解，不得据此实现。包含职位信息完整性分析的调用示例，展示AgentRequest请求结构、response处理逻辑、错误处理机制等关键接口使用方法。
```

------------------------------

## H: 完整技术规范约束

### H-1: Python环境完整规范
```
├── H-1.1: Python版本 - Python 3.10+（强制）
├── H-1.2: 运行环境 - 支持asyncio异步并发处理
├── H-1.3: 依赖管理 - 使用requirements.txt管理依赖版本
└── H-1.4: 资源要求 - 内存512MB+，CPU 1核+
```

------------------------------

### H-2: Pydantic V2完整规范
```
├── H-2.1: 必须使用 - model_validate()、model_dump()、Field()、BaseModel
├── H-2.2: 严禁使用 - .dict()、.parse_obj()、.json()、parse_obj_as()
├── H-2.3: 字段验证 - 必须使用pattern=r"regex"，严禁使用regex=r"regex"
├── H-2.4: 模型导入 - 统一从global_schemas导入，禁止本地重复定义
└── H-2.5: 模型验证机制 - 从global_schemas导入JobPost、JobRequirements、CompanyProfile模型，使用model_validate()验证输入数据，model_dump()序列化输出结果
```

------------------------------

### H-3: 异步处理完整规范
```
├── H-3.1: 必须 - 所有文档处理和分析方法使用async def
├── H-3.2: 禁止 - 同步阻塞操作、threading、multiprocessing
├── H-3.3: 并发 - 使用asyncio.create_task()、asyncio.gather()处理并发文档分析
└── H-3.4: 并发处理机制 - 使用asyncio.create_task()创建文档内容提取、完整性分析、标签生成并发任务，通过asyncio.gather()并行执行并聚合职位分析结果
```

------------------------------

### H-4: 配置管理完整规范
```
├── H-4.1: 获取方式 - 通过await routing_agent.get_config("jobpost_agent", config_type)
├── H-4.2: 配置类型 - "field_requirements"、"document_parsing"、"llm_prompts"、"validation_rules"
├── H-4.3: 严禁 - 硬编码配置、本地配置文件、环境变量直接读取
├── H-4.4: 热更新 - 支持配置实时更新，无需重启服务
└── H-4.5: 配置示例 - 包含load_jobpost_config方法示例，展示配置获取和处理逻辑
```

------------------------------

### H-5: LLM调用完整规范
```
├── H-5.1: 主要用途 - 职位描述分析、完整性检查、内容优化
├── H-5.2: 调用方式 - 通过await routing_agent.call_agent("llm_handler_agent", payload)
├── H-5.3: 严禁 - 直接访问OpenAI、Claude、Gemini等API
├── H-5.4: 模型 - 强制使用gpt-4o-2024-08-06
└── H-5.5: LLM调用示例 - 包含analyze_jobpost_completeness_with_llm方法示例，展示LLM调用的完整流程
```

------------------------------

### H-6: 模块协作完整规范
```
├── H-6.1: 被动调用 - 仅响应routing_agent的职位处理任务分发，不主动运行
├── H-6.2: 无状态 - 完全无状态设计，每次调用独立完成，不保存处理状态
├── H-6.3: 中枢调度 - 与其他模块交互统一通过await routing_agent.call_agent()
├── H-6.4: 统一入口 - 仅暴露async def run(request: AgentRequest) -> AgentResponse接口
└── H-6.5: 数据协作 - 与database_agent协作存储职位信息、与taggings_agent协作生成职位信息标签
```

------------------------------

### H-7: 日志记录完整规范
```
├── H-7.1: 日志框架 - 使用Python标准logging模块
├── H-7.2: 必要字段 - request_id、agent_name、company_id、job_id、processing_stage、document_count
├── H-7.3: 结构化 - JSON格式，包含职位处理上下文信息
├── H-7.4: 禁止 - 使用print()进行任何输出
└── H-7.5: 日志示例 - 包含结构化日志记录的完整示例
```

------------------------------

### H-8: 异常处理与技术支持策略
```
├── H-8.1: 统一重试机制 - 所有职位信息解析失败情况统一要求重新上传，再次尝试
├── H-8.2: 异常类型 - JobPostParsingError、FieldValidationError、ContentQualityError
├── H-8.3: 向上传播 - 异常向routing_agent传播，提供详细的错误上下文
├── H-8.4: 零容错简化处理 - 文档解析失败、字段验证异常等所有错误统一返回失败状态
├── H-8.5: 用户友好反馈 - 提供明确失败原因和重新上传指导，包含一键技术支持邮件功能
├── H-8.6: 技术支持邮件 - 如果用户碰到无法处理的问题，提供support@4waysgroup.com邮件联系方式
└── H-8.7: 一键邮件模板 - 自动收集职位信息解析问题信息，生成技术支持邮件模板供用户复制发送
```

------------------------------

### H-9: 职位解析统一处理策略
```
├── H-9.1: 职位解析错误状态枚举
│   ├── H-9.1.1: 文档处理错误 - JOBPOST_UPLOAD_ERROR、FORMAT_UNSUPPORTED、FILE_SIZE_ERROR
│   ├── H-9.1.2: 信息提取错误 - EXTRACTION_ERROR、CONTENT_INSUFFICIENT、PARSING_QUALITY_LOW
│   ├── H-9.1.3: 字段验证错误 - FIELD_VALIDATION_ERROR、COMPLETENESS_ERROR
│   └── H-9.1.4: 系统技术错误 - SYSTEM_ERROR
├── H-9.2: 统一处理原则
│   ├── H-9.2.1: 所有职位解析失败场景均要求重新上传，不提供特殊处理路径
│   ├── H-9.2.2: 提供一键技术支持邮件模板生成功能：support@4waysgroup.com
│   └── H-9.2.3: 失败反馈包含明确原因+重新上传指导+邮件支持选项
├── H-9.3: 职位解析失败对话反馈示例 - 包含完整的失败反馈模板和用户指导
└── H-9.4: 一键技术支持邮件模板功能 - 包含邮件模板生成和复制功能的详细实现
```

------------------------------

### H-10: 测试规范完整约束
```
├── H-10.1: 生产级测试 - 使用真实的职位文档和完整性验证，禁用Mock机制
├── H-10.2: 完整流程 - 测试文档解析→完整性检查→内容优化→标签生成的完整链路
├── H-10.3: 质量验证 - 验证职位信息提取的准确性和完整性
└── H-10.4: 测试示例 - 包含TestJobpostAgent类的完整测试用例示例
```

------------------------------

### H-11: 部署规范完整约束
```
├── H-11.1: 环境要求 - Python 3.10+，内存512MB+，CPU 1核+
├── H-11.2: 依赖服务 - routing_agent、llm_handler_agent、database_agent、taggings_agent
├── H-11.3: 监控指标 - 文档处理成功率>95%，响应时间<6秒，字段完整性检查准确率>90%
└── H-11.4: 健康检查 - 文档解析能力验证、字段验证规则检查、LLM服务连通性验证
```

------------------------------

## I: 模块架构设计约束

### I-1: 架构设计原则
```
├── I-1.1: 主入口文件职责 - 仅提供统一接口注册和任务分发能力，不实现具体业务逻辑，保持主文件简洁性和可维护性
├── I-1.2: 业务实现分离 - 所有具体业务功能必须通过独立的业务处理模块实现，包括职位信息解析与结构化数据提取、多格式文档处理与内容分析、职位字段验证与完整性检查、企业职位档案生成与标准化、职位配置加载与规则管理
├── I-1.3: 模块化组织约束 - 避免单一文件承载过多业务逻辑，按功能域进行合理拆分，每个业务模块专注单一职责，确保代码可测试性和可维护性，通过依赖注入和接口抽象，降低模块间耦合度
└── I-1.4: 配置驱动 - 所有职位字段要求、AI分析提示模板、验证规则通过routing_agent从global_config动态获取，支持热更新和版本管理
```

------------------------------

## J: 详细运行流程

### J-1: 多源输入处理链路
```
├── J-1.1: 输入数据收集
│   ├── J-1.1.1: 文本输入 - 优先使用text_input，其次从context.data.message获取
│   ├── J-1.1.2: 文件处理 - 支持文件URL下载和直接文件传递
│   ├── J-1.1.3: 格式识别 - 自动识别文件类型和编码格式
│   └── J-1.1.4: 内容整合 - 将多个来源的内容整合为完整描述
├── J-1.2: 文档处理与文本提取
│   ├── J-1.2.1: PDF处理 - 使用pypdf库逐页提取文本内容
│   ├── J-1.2.2: DOCX处理 - 使用python-docx库提取段落文本
│   ├── J-1.2.3: 图像处理 - 保留原始Base64格式供LLM视觉分析
│   └── J-1.2.4: 纯文本 - 直接UTF-8解码处理
├── J-1.3: AI分析与完整性检查
│   ├── J-1.3.1: 配置加载 - 加载职位要求配置和提示模板
│   ├── J-1.3.2: LLM调用 - 通过routing_agent调用LLM进行分析
│   ├── J-1.3.3: 完整性验证 - 检查职位发布是否包含所有必需字段
│   └── J-1.3.4: 结果分类 - 根据完整性返回不同的处理路径
├── J-1.4: 双路径处理逻辑
│   ├── J-1.4.1: 不完整路径 - 返回INCOMPLETE状态和具体缺失字段的问题列表
│   ├── J-1.4.2: 完整路径 - 返回COMPLETE状态、优化后的职位描述和提取的标签数据
│   └── J-1.4.3: 状态跟踪 - 提供字段状态详情和精确的完整性反馈
├── J-1.5: 数据优化与提取
│   ├── J-1.5.1: 内容优化 - 对完整的职位发布进行AI优化，提升吸引力
│   ├── J-1.5.2: 关键信息提取 - 提取职位标题、技能要求、经验水平等关键数据
│   └── J-1.5.3: 标签数据生成 - 生成适合后续匹配和标签生成的结构化数据
└── J-1.6: 响应构建与输出
    ├── J-1.6.1: 标准化响应 - 使用ResponseRules创建统一格式响应
    ├── J-1.6.2: 详细信息 - 包含处理状态、数据内容、请求追踪信息
    └── J-1.6.3: 错误处理 - 提供详细的异常处理和错误分类
```

------------------------------

## K: 职位字段要求规范

### K-1: 必需字段清单
```
├── K-1.1: job_title - 职位标题，必须有清晰具体的职位标题，避免内部行话
├── K-1.2: company_overview - 企业概述，必须包含企业业务、行业、文化的简要介绍
├── K-1.3: job_description - 职位描述，必须详细描述日常任务、关键职责、汇报关系
├── K-1.4: job_requirements - 职位要求，必须列出具体技能要求、资格证书、工作年限
├── K-1.5: employment_type - 雇佣类型，必须明确标明为'Full-Time'
├── K-1.6: work_schedule - 工作时间，必须指定工作时间，如'周一至周五，9AM-6PM'
├── K-1.7: work_location - 工作地点，必须明确现场/远程/混合模式及具体城市
├── K-1.8: salary_range - 薪资范围，必须提供明确月薪范围，如'PHP 50,000-70,000/月'
└── K-1.9: benefits - 福利待遇，必须明确政府强制福利(SSS、PhilHealth、Pag-IBIG)
```

------------------------------

### K-2: 输出数据结构
```
├── K-2.1: 不完整状态输出
│   ├── K-2.1.1: status - "INCOMPLETE"
│   ├── K-2.1.2: issues - 缺失信息的具体问题描述列表
│   └── K-2.1.3: field_statuses - 字段状态详情，包含field_name、status、reason
└── K-2.2: 完整状态输出
    ├── K-2.2.1: status - "COMPLETE"
    ├── K-2.2.2: final_job_post - 优化后的职位发布文本(Markdown格式)
    └── K-2.2.3: extracted_data_for_tagging - 提取的标签数据，包含job_title、key_skills、experience_level、location、employment_type
```

------------------------------

## L: 文档处理支持

### L-1: 职位文档上传集成
```
├── L-1.1: jobpost_agent调度 - 职位发布文档处理
├── L-1.2: 发布状态管理 - job_posting状态流程控制
├── L-1.3: 解析失败处理 - 职位文档解析失败处理
└── L-1.4: 发布重试支持 - job_posting_retry状态机制
```

------------------------------

### L-2: 支持的文件格式
```
├── L-2.1: PDF文档 - 通过pypdf库提取文本，支持多页文档
├── L-2.2: DOCX文档 - 通过python-docx库提取段落文本
├── L-2.3: 纯文本 - TXT、Markdown等格式直接UTF-8解码
└── L-2.4: 图像文件 - 保留原始格式供LLM视觉分析
```

------------------------------

### L-3: 通用上传优化
```
├── L-3.1: 文件格式验证 - 支持PDF、DOC、DOCX等格式
├── L-3.2: 文件大小限制 - 上传文件大小的限制机制
├── L-3.3: 上传进度跟踪 - 文件上传进度的状态跟踪
└── L-3.4: 临时文件清理 - 上传临时文件的清理机制
```

------------------------------

### L-4: 文档处理策略
```
├── L-4.1: 实时处理 - 文档下载和提取实时进行，不持久化存储
├── L-4.2: 内存处理 - 使用内存缓冲区处理文件，避免临时文件
├── L-4.3: 清理机制 - 请求完成后自动释放内存，无文件残留
└── L-4.4: 错误容错 - 文档提取失败时记录警告但不中断主流程
```

------------------------------

## M: 快速启动指南

### M-1: Prerequisites
```
├── M-1.1: Python 3.10+
├── M-1.2: routing_agent配置就绪
└── M-1.3: 文档处理库依赖
```

------------------------------

### M-2: Install & Configure
```
├── M-2.1: 安装依赖 - pip install pypdf python-docx aiofiles>=23.0.0（已包含在全局requirements.txt）
└── M-2.2: 职位字段配置 - JOB_REQUIRED_FIELDS = ["职位标题", "工作地点", "职位职责", "任职要求"]（通过routing_agent获取）
```

------------------------------

### M-3: Run & Smoke Test
```
包含最小职位解析测试的完整代码示例，展示request构建、run方法调用、结果处理等关键步骤。
```

------------------------------

### M-4: 常见故障排查
```
├── M-4.1: 文档解析失败 - 检查文件格式，确保PDF/DOCX可读
├── M-4.2: 字段提取不完整 - 确认职位描述内容详细，包含必需信息
└── M-4.3: LLM调用失败 - 检查llm_handler_agent状态和网络连接
```

------------------------------

## N: 核心接口定义

### N-1: 主接口run()方法
```
├── N-1.1: Name - run(request: AgentRequest) -> AgentResponse
├── N-1.2: Method - 异步函数调用
├── N-1.3: Path/Topic - 通过routing_agent调用，职位发布处理任务
├── N-1.4: Minimal Request - 包含request_id、task_type、user_id、context等字段的JSON结构
├── N-1.5: Minimal Response - 包含status、data、completeness_score等字段的JSON结构
└── N-1.6: Error Codes - JOBPOST_UPLOAD_ERROR、EXTRACTION_ERROR、FIELD_VALIDATION_ERROR、SYSTEM_ERROR
```

------------------------------

### N-2: 依赖说明
```
├── N-2.1: 核心依赖 - pypdf>=3.0.0、python-docx>=0.8.0、aiofiles>=23.0.0
├── N-2.2: Agent依赖 - llm_handler_agent(内容分析)、routing_agent(配置管理)、taggings_agent(标签生成)
├── N-2.3: 运行环境 - Python 3.10+、256MB+内存(文档处理)
└── N-2.4: 外部服务 - MinIO存储(文档上传)、OpenAI API(内容分析)
```

------------------------------

## O: 技术规范遵循

### O-1: 核心约束
```
├── O-1.1: LLM访问约束 - 职位信息分析如需AI能力，必须通过llm_handler_agent调用
├── O-1.2: 严禁Fallback - 职位发布验证不得使用mock机制，必须真实验证字段完整性
└── O-1.3: 数据格式 - 输入输出严格遵循AgentRequest和AgentResponse
```

------------------------------

### O-2: 架构约束
```
├── O-2.1: 无状态设计 - 完全无状态，支持并发处理多个职位发布
├── O-2.2: 文件处理 - 使用内存缓冲区处理文件，避免临时文件
├── O-2.3: 配置驱动 - 所有提示模板和要求通过routing_agent从global_config获取
└── O-2.4: 资源管理 - 通过依赖注入管理routing_agent调度接口
```

------------------------------

### O-3: 质量控制约束
```
├── O-3.1: JSON格式强制 - LLM输出必须为有效JSON格式
├── O-3.2: 完整性验证 - 严格按照预定义字段要求验证职位完整性
├── O-3.3: 文本长度限制 - 通过settings配置限制职位文本最大长度
└── O-3.4: 异常处理 - 使用分层异常处理，确保错误信息的准确性
```

------------------------------

## P: 术语与名词表

### P-1: 核心概念唯一叫法
```
├── P-1.1: jobpost_agent - 模块标准名称，职位信息处理中心
├── P-1.2: 职位信息 - 统一使用此术语，替代"职位发布"、"职位"、"职位档案"等变体
├── P-1.3: 企业 - 统一使用此术语，不使用"公司"
├── P-1.4: 任务类型 - task_type，统一使用英文字段名
├── P-1.5: 错误码格式 - 统一使用{DOMAIN}/{REASON}格式
└── P-1.6: 状态枚举 - 统一使用英文常量名(DRAFT、COMPLETE、PUBLISHED等)
```

------------------------------

### P-2: 关键术语定义
```
├── P-2.1: 职位信息处理 - 对职位相关文档和数据进行解析、验证、优化的完整流程
├── P-2.2: 双路径处理机制 - 根据职位信息完整性分为完整路径(优化)和不完整路径(补充)
├── P-2.3: 企业维度管理 - 基于用户验证企业身份进行职位信息归属和权限管理
├── P-2.4: 打标触发 - 职位信息处理完成后自动触发标签生成的机制
└── P-2.5: 配置驱动 - 通过routing_agent统一获取配置，支持热更新的架构模式
```

------------------------------

## Q: 模块契约总结

### Q-1: 核心职责与运行模式
```
├── Q-1.1: 核心职责 - 职位信息处理、文档解析、完整性验证、内容优化、标签数据提取
├── Q-1.2: 运行模式 - 被动调用，无状态设计，多格式支持，AI辅助分析
├── Q-1.3: 处理能力 - 9个必需字段验证，多种文档格式支持，双路径处理逻辑，结构化数据提取
└── Q-1.4: AI集成 - 通过routing_agent调用LLM，支持文档视觉分析和JSON输出
```

------------------------------

### Q-2: 架构特性与约束
```
├── Q-2.1: 架构特性 - 配置驱动，实时处理，内存管理，错误容错机制
├── Q-2.2: 严格约束 - 无Mock机制，真实验证，配置管理，异步并发处理
├── Q-2.3: 关键价值 - 智能处理、质量保障、用户友好、系统集成
└── Q-2.4: 系统定位 - 确保企业发布的职位信息的完整性和质量，为整个Career Bot系统的智能匹配功能提供可靠的职位数据基础，是连接企业需求和人才匹配的重要桥梁
```

------------------------------

## R: 待补要点

### R-1: 配置参数待补
```
├── R-1.1: 缺失的配置键名
│   ├── R-1.1.1: jobpost_agent.field_requirements.completeness_threshold - 建议默认值0.85，取值域[0.7, 1.0]，影响职位发布完整性判断的严格程度
│   ├── R-1.1.2: jobpost_agent.document_parsing.max_file_size_mb - 建议默认值5MB，取值域[1, 10]，影响职位文档上传的文件大小限制
│   └── R-1.1.3: jobpost_agent.timeout_config.document_processing_timeout - 建议默认值45秒，取值域[30, 120]，影响文档处理和LLM分析的超时控制
└── R-1.2: 最小决策集 - 每个配置项提供2-3个可选项，偏保守选择
```

------------------------------

### R-2: Schema字段待补
```
├── R-2.1: global_schemas中缺失的字段定义
│   ├── R-2.1.1: JobPost.brainstorm_analysis - 建议类型Dict[str, Any]，影响职位深度分析和头脑风暴结果存储
│   ├── R-2.1.2: JobRequirements.soft_skills - 建议类型List[str]，影响软技能要求的标准化存储和匹配
│   └── R-2.1.3: JobPost.completeness_score - 建议类型float，影响职位信息完整性评分的量化存储
└── R-2.2: 最小决策集 - 结构化字典格式vs JSON字符串格式，字符串列表vs枚举类型，0-1浮点数vs 0-100整数
```

------------------------------

### R-3: 路径映射待补
```
├── R-3.1: 未明确的文件路径
│   └── R-3.1.1: 职位文档临时处理目录 - 待确认路径{MODULE_ROOT}/temp_processing/ vs 内存处理，影响文档处理期间的临时存储策略
└── R-3.2: 最小决策集 - 纯内存处理（避免文件系统依赖）vs 临时目录处理（支持大文件处理）
```

------------------------------

### R-4: 错误码待补
```
├── R-4.1: 模块特定错误码
│   ├── R-4.1.1: 职位字段验证失败的细分 - 建议错误码JOBPOST/FIELD_MISSING_REQUIRED，错误消息模板"职位必填字段缺失: {missing_fields}"
│   └── R-4.1.2: 文档格式不支持的具体情况 - 建议错误码JOBPOST/UNSUPPORTED_FILE_FORMAT，错误消息模板"不支持的文档格式: {file_format}"
└── R-4.2: 最小决策集 - 细分字段错误类型vs统一字段验证错误，详细格式错误信息vs统一格式错误提示
```

------------------------------

### R-5: 指标名称待补
```
├── R-5.1: 性能监控指标
│   └── R-5.1.1: 职位字段完整性分布监控 - 建议指标名jobpost_field_completeness_distribution，指标类型Histogram，标签维度field_name、completion_status、company_type
└── R-5.2: 最小决策集 - 详细标签维度（精细化监控）vs 简化标签维度（降低复杂度）
```

------------------------------

### R-6: 依赖关系待补
```
├── R-6.1: 模块间协作关系
│   └── R-6.1.1: 与taggings_agent的职位标签生成协作 - 目标模块taggings_agent，交互方式通过routing_agent调度传递职位数据，数据传递格式结构化职位信息和提取的关键词
└── R-6.2: 最小决策集 - 实时标签生成（即时反馈）vs 异步标签生成（性能优化）
```

------------------------------

### R-7: 业务规则待补
```
├── R-7.1: 业务逻辑决策点
│   ├── R-7.1.1: 职位信息不完整时的处理策略 - 决策点：部分信息缺失时是否允许发布并后续补充，影响用户体验和职位信息质量的平衡
│   └── R-7.1.2: 多文档内容冲突时的处理逻辑 - 决策点：当上传的多个文档包含不一致信息时的处理方式，影响职位信息的准确性和一致性
└── R-7.2: 最小决策集 - 严格要求完整信息vs允许分阶段补充vs可配置策略，提示用户解决冲突vs自动选择最完整的信息vs合并所有信息并标记冲突
```

------------------------------

### R-8: 统一化修订清单
```
├── R-8.1: 本次收口完成
│   ├── R-8.1.1: 术语统一 - 已将"职位发布/职位/职位档案"统一为"职位信息"
│   ├── R-8.1.2: 企业术语统一 - 已将"公司"统一为"企业"
│   ├── R-8.1.3: 错误码格式统一 - 已明确使用{DOMAIN}/{REASON}格式
│   ├── R-8.1.4: 接口契约对齐 - 已确立权威接口定义
│   ├── R-8.1.5: 依赖关系锚定 - 已确立权威依赖关系定义
│   └── R-8.1.6: 重大决策锚定 - 已确立权威业务策略定义
└── R-8.2: 仍需明确的配置项
    ├── R-8.2.1: 完整性阈值 - jobpost_agent.field_requirements.completeness_threshold建议0.85
    ├── R-8.2.2: 文件大小限制 - jobpost_agent.document_parsing.max_file_size_mb建议5MB
    └── R-8.2.3: 处理超时 - jobpost_agent.timeout_config.document_processing_timeout建议45秒
```

------------------------------

### R-9: 重要提醒
```
⚠️ 上述待补要点未明确前，AI代码生成器应该停止实现相关功能，等待明确指令后再继续。禁止基于假设或经验进行"脑补"。
```
