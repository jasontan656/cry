# mail_agent 结构化文档骨架

## 字段迁移说明
```
所有数据模型/Schema已迁移至global_schemas.json，由routing_agent动态生成和分发：
- ContextData模型 - context.data通信字段已迁移至global_schemas.json
- ProcessingResult模型 - 邮件处理结果结构已迁移至global_schemas.json
- SystemError模型 - 邮件发送错误处理已迁移至global_schemas.json

所有配置参数已迁移至global_config.json：
- mail_agent配置组包含smtp_config、template_config、support_config等
```

## A: 开发边界与职责说明

```
mail_agent是Career Bot系统的邮件服务处理中心，负责处理所有邮件发送和管理相关功能。该模块管理邮件发送、模板渲染、队列处理和状态跟踪，为用户认证、通知推送和系统通信提供可靠的邮件服务支持。作为被动调用的业务Agent，不包含启动逻辑和测试代码，通过routing_agent进行统一调度。
```

------------------------------

### A-1: 模块基本定义

```
mail_agent是Career Bot系统的邮件服务处理中心，承担系统内所有邮件通信的核心职责。该模块采用被动调用模式，仅响应routing_agent的任务调度，不主动运行。模块设计为完全无状态，每次调用独立完成，通过异步队列处理机制支持高并发邮件发送。
```

------------------------------

### A-2: 核心功能特性

```
├── A-2.1: 邮件发送服务
│   ├── A-2.1.1: 验证码邮件 - 用户注册、密码重置等验证码发送
│   ├── A-2.1.2: 通知邮件 - 系统通知、匹配结果、状态更新等
│   ├── A-2.1.3: 简历下架通知邮件 - 简历被购买10次后的自动下架通知
│   ├── A-2.1.4: 营销邮件 - 产品更新、功能介绍、用户活动等
│   ├── A-2.1.5: 事务邮件 - 订单确认、服务变更等重要业务邮件
│   └── A-2.1.6: 批量邮件 - 支持批量发送和个性化内容
├── A-2.2: 邮件模板管理
│   ├── A-2.2.1: 模板引擎 - 基于Jinja2的动态模板渲染
│   ├── A-2.2.2: 多语言支持 - 支持中英文等多语言邮件模板
│   ├── A-2.2.3: 响应式设计 - 自适应手机和桌面端的邮件样式
│   ├── A-2.2.4: 品牌一致性 - 统一的视觉设计和品牌元素
│   ├── A-2.2.5: A/B测试 - 支持不同模板版本的效果测试
│   └── A-2.2.6: 技术支持邮件 - 统一的一键技术支持邮件模板生成功能
└── A-2.3: 队列处理机制
    ├── A-2.3.1: 异步队列 - 基于Redis的异步邮件发送队列
    ├── A-2.3.2: 优先级管理 - 验证码等紧急邮件优先发送
    ├── A-2.3.3: 失败重试 - 自动重试机制和指数退避策略
    ├── A-2.3.4: 限流控制 - 防止邮件服务商限制的发送速率控制
    └── A-2.3.5: 状态跟踪 - 邮件发送状态的实时跟踪和记录
```

------------------------------

### A-3: 模块接入说明

```
mail_agent是被动调用的业务Agent，不包含启动逻辑和测试代码。整个Career Bot系统的启动入口统一在boot/目录中。系统启动使用python main.py --start从boot/启动整个系统，模块装配通过boot/launcher.py基于applications/__registry__.py装配，启动后通过routing_agent进行统一调度，功能测试已迁移至utility_tools/global_test/进行独立管理。
```

------------------------------

### B: 系统架构与模块定义

```
├── B-1: 架构设计原则
│   ├── B-1.1: 主入口文件职责 - 仅提供统一接口注册和任务分发能力，不实现具体业务逻辑
│   ├── B-1.2: 业务实现分离 - 所有具体业务功能通过独立的业务处理模块实现
│   ├── B-1.3: 模块化组织约束 - 按功能域进行合理拆分，每个业务模块专注单一职责
│   └── B-1.4: 配置驱动 - 所有邮件模板、服务商配置、队列设置通过routing_agent动态获取
├── B-2: 系统架构位置
│   └── B-2.1: 调用链路 - auth_agent/其他模块 → routing_agent → [mail_agent] → SMTP服务商
└── B-3: 模块协作规范
    ├── B-3.1: 被动调用 - 仅响应routing_agent的邮件发送任务分发，不主动运行
    ├── B-3.2: 无状态设计 - 完全无状态设计，每次调用独立完成，不保存发送状态
    ├── B-3.3: 中枢调度 - 与其他模块交互统一通过await routing_agent.call_agent()
    └── B-3.4: 统一入口 - 仅暴露async def run(request: AgentRequest) -> AgentResponse接口
```

------------------------------

### C: 输入输出规范

```
├── C-1: 核心接口定义
│   ├── C-1.1: 主接口run()方法
│   │   ├── C-1.1.1: 方法签名 - run(request: AgentRequest) -> AgentResponse
│   │   ├── C-1.1.2: 调用方式 - 异步函数调用，通过routing_agent调用
│   │   ├── C-1.1.3: 最小请求格式 - 包含request_id、task_type、user_id、context等字段
│   │   ├── C-1.1.4: 最小响应格式 - 包含success、response、error等字段
│   │   └── C-1.1.5: 错误码规范 - 使用DOMAIN/REASON格式，如MAIL/SEND_FAILED
│   └── C-1.2: 支持的任务类型
│       ├── C-1.2.1: 邮件发送 - send_email
│       ├── C-1.2.2: 验证码邮件 - send_verification_code
│       ├── C-1.2.3: 简历下架通知 - send_resume_deactivation
│       ├── C-1.2.4: 批量邮件 - send_bulk_email
│       ├── C-1.2.5: 邮件状态查询 - check_email_status
│       ├── C-1.2.6: 健康检查 - health_check
│       └── C-1.2.7: 配置获取 - get_config
├── C-2: 数据模型规范
│   ├── C-2.1: 必须使用的Schema - 从global_schemas导入的标准模型
│   │   ├── C-2.1.1: AgentRequest - 请求载荷模型
│   │   ├── C-2.1.2: AgentResponse - 响应载荷模型
│   │   ├── C-2.1.3: EmailMessage - 邮件消息模型
│   │   ├── C-2.1.4: EmailTemplate - 邮件模板模型
│   │   └── C-2.1.5: EmailStatus - 邮件状态模型
│   └── C-2.2: 模型验证机制 - 使用model_validate()验证输入数据，model_dump()序列化输出结果
└── C-3: 错误码规范
    ├── C-3.1: 标准错误码格式 - 使用{DOMAIN}/{REASON}命名格式
    ├── C-3.2: 通用错误码
    │   ├── C-3.2.1: VALIDATION/INVALID_INPUT - 输入参数验证失败
    │   ├── C-3.2.2: CONFIG/NOT_FOUND - 配置项不存在
    │   ├── C-3.2.3: CONFIG/INVALID_FORMAT - 配置格式错误
    │   ├── C-3.2.4: TIMEOUT/REQUEST_TIMEOUT - 请求处理超时
    │   ├── C-3.2.5: AUTH/UNAUTHORIZED - 权限验证失败
    │   └── C-3.2.6: IO/UNAVAILABLE - 外部服务不可用
    └── C-3.3: 邮件服务特定错误码
        ├── C-3.3.1: MAIL/INVALID_EMAIL_ADDRESS - 邮箱地址格式错误或无效
        ├── C-3.3.2: MAIL/SMTP_CONNECTION_FAILED - SMTP连接失败或超时
        ├── C-3.3.3: MAIL/TEMPLATE_RENDERING_ERROR - 邮件模板渲染失败
        ├── C-3.3.4: MAIL/SEND_QUOTA_EXCEEDED - 邮件发送配额超限
        ├── C-3.3.5: MAIL/RECIPIENT_REJECTED - 收件人地址被拒绝
        ├── C-3.3.6: MAIL/AUTHENTICATION_FAILED - SMTP认证失败
        └── C-3.3.7: MAIL/QUEUE_PROCESSING_ERROR - 邮件队列处理异常
```

------------------------------

### D: 配置机制

```
├── D-1: 配置获取方式
│   ├── D-1.1: 统一配置来源 - 配置仅可经由routing_agent的config_manager服务读取
│   ├── D-1.2: 配置获取方法 - 通过await routing_agent.get_config("mail_agent", config_type)
│   ├── D-1.3: 热更新支持 - 支持配置实时更新，无需重启服务
│   └── D-1.4: 配置验证 - 启动时验证所有SMTP配置的有效性
├── D-2: 必需配置项
│   ├── D-2.1: 基础配置 - basic_config
│   ├── D-2.2: 超时配置 - timeout_config
│   ├── D-2.3: 重试配置 - retry_config
│   ├── D-2.4: SMTP配置 - smtp_config
│   ├── D-2.5: 邮件模板配置 - email_templates
│   ├── D-2.6: 队列配置 - queue_config
│   └── D-2.7: 发送配置 - sending_config
├── D-3: 配置键名定义
│   ├── D-3.1: 模板配置键
│   │   ├── D-3.1.1: mail_agent.resume_deactivation_template - 下架通知邮件模板
│   │   ├── D-3.1.2: mail_agent.verification_code_template - 验证码邮件模板
│   │   └── D-3.1.3: mail_agent.email_sender_config - 发件人信息配置
│   └── D-3.2: 队列配置键
│       ├── D-3.2.1: mail_agent.queue_priorities - 队列优先级配置
│       ├── D-3.2.2: mail_agent.retry_max_attempts - 最大重试次数（默认值: 3）
│       ├── D-3.2.3: mail_agent.dedup_window_hours - 去重时间窗口（默认值: 24）
│       └── D-3.2.4: mail_agent.purchase_count_trigger - 购买触发阈值（固定值: 10）
└── D-4: SMTP服务商配置
    ├── D-4.1: 主要服务商 - Brevo SMTP作为主要邮件服务提供商
    ├── D-4.2: 发送方信息
    │   ├── D-4.2.1: 系统邮件 - admin@4waysgroup.com (4WAYS GROUP)
    │   └── D-4.2.2: 技术支持邮件接收 - support@4waysgroup.com (技术支持团队)
    ├── D-4.3: 多服务商容错 - 支持AWS SES、SendGrid等作为备用服务商
    ├── D-4.4: 动态切换 - 支持运行时切换邮件服务商
    └── D-4.5: 安全管理 - SMTP密码等敏感信息通过routing_agent安全获取
```

------------------------------

### E: 模型路径与调用方式

```
├── E-1: 依赖模块清单
│   ├── E-1.1: 必须依赖
│   │   ├── E-1.1.1: routing_agent - 统一调度和配置管理
│   │   ├── E-1.1.2: global_schemas - 数据模型定义
│   │   └── E-1.1.3: database_agent - 邮件状态存储和用户信息获取
│   └── E-1.2: 可选依赖
│       └── E-1.2.1: llm_handler_agent - 动态邮件内容生成（特殊场景）
├── E-2: 依赖与职责
│   ├── E-2.1: 上游触发（谁调用本模块）
│   │   ├── E-2.1.1: routing_agent - 唯一任务调度来源，提供邮件发送任务和配置管理
│   │   ├── E-2.1.2: database_agent - 购买计数触发，当purchase_count_trigger达到阈值时触发下架通知
│   │   ├── E-2.1.3: auth_agent - 用户认证流程触发，发送验证码邮件和密码重置邮件
│   │   ├── E-2.1.4: matching_agent - 匹配结果触发，发送搜索结果和匹配成功通知邮件
│   │   └── E-2.1.5: company_identity_agent - 企业审核触发，发送审核状态变更通知邮件
│   ├── E-2.2: 下游调用（本模块调用谁）
│   │   ├── E-2.2.1: SMTP服务提供商 - 邮件实际发送，通过标准SMTP协议发送邮件
│   │   ├── E-2.2.2: database_agent - 状态持久化，存储email_delivery_status和重试计数
│   │   └── E-2.2.3: routing_agent - 配置获取，通过get_config()获取模板和SMTP配置
│   └── E-2.3: 数据读写职责
│       ├── E-2.3.1: 读取权限 - 用户基础信息（姓名、邮箱）、邮件模板配置、SMTP服务商配置
│       ├── E-2.3.2: 写入权限 - email_delivery_status状态更新、发送失败计数、邮件发送日志
│       ├── E-2.3.3: 过滤维度 - 邮件类型过滤、收件人去重、时间窗口限制（24小时内去重）
│       └── E-2.3.4: 并发控制 - 异步队列处理，按优先级顺序处理，无状态并发安全
└── E-3: 调用方式规范
    ├── E-3.1: 统一入口 - 仅暴露run()方法作为唯一接口
    ├── E-3.2: 异步处理 - 所有函数使用async def，支持批量邮件发送
    ├── E-3.3: 并发发送机制 - 使用asyncio.create_task()创建并发邮件发送任务
    └── E-3.4: LLM调用规范 - 仅在个性化邮件内容生成时使用LLM，通过routing_agent调用
```

------------------------------

### F: 用户流程与对话流程

```
├── F-1: 邮件发送流程
│   ├── F-1.1: 邮件请求接收 - 接收来自其他模块的邮件发送请求，验证请求格式和必需参数
│   ├── F-1.2: 模板处理 - 根据邮件类型选择相应模板，使用Jinja2引擎渲染动态内容
│   ├── F-1.3: 队列管理 - 将邮件任务添加到Redis队列，根据优先级和类型分配队列
│   ├── F-1.4: 邮件发送 - 从队列取出邮件任务，通过SMTP适配器连接邮件服务商
│   ├── F-1.5: 状态跟踪 - 记录邮件发送状态，更新投递统计和成功率
│   └── F-1.6: 结果返回 - 返回标准化响应格式，包含发送状态和跟踪信息
├── F-2: 触发条件与时序
│   ├── F-2.1: 购买计数触发 - 严格按purchase_count_trigger = 10时精确触发一次下架通知
│   ├── F-2.2: 验证码触发 - 用户操作后立即触发，高优先级处理（10分钟内必达）
│   ├── F-2.3: 通知类邮件 - 业务事件后5分钟内触发，中等优先级处理
│   └── F-2.4: 营销邮件 - 异步批量处理，低优先级队列，非实时要求
└── F-3: 测试环境邮件处理机制
    ├── F-3.1: 测试邮件拦截机制 - 激活条件ENV=test环境变量 + 收件人邮箱包含@test.域名
    ├── F-3.2: 测试邮件拦截处理流程 - 识别测试邮箱、提取验证码、存储至Redis、阻止实际发送
    ├── F-3.3: 测试验证码提取API接口 - 供E2E测试脚本调用，获取拦截的验证码
    └── F-3.4: 测试邮箱识别规则 - 包含@test.、@e2e.、@local.、@example.com域名
```

------------------------------

### G: 意图识别机制

```
⚠️ 未定义 - mail_agent作为邮件服务模块，主要处理邮件发送任务，不涉及复杂的意图识别机制。邮件类型和处理逻辑主要基于task_type和email_type字段进行识别和分发。
```

------------------------------

### H: 接口结构

```
├── H-1: 支持的邮件类型
│   ├── H-1.1: verification_code - 用户注册/登录验证码（高优先级）
│   ├── H-1.2: password_reset - 密码重置链接（高优先级）
│   ├── H-1.3: welcome - 新用户欢迎邮件（中优先级）
│   ├── H-1.4: match_notification - 职位匹配通知（中优先级）
│   ├── H-1.5: profile_update - 个人资料更新确认（低优先级）
│   ├── H-1.6: system_notification - 系统通知和公告（中优先级）
│   ├── H-1.7: marketing - 产品推广和营销（低优先级）
│   └── H-1.8: invoice - 账单和付费相关（高优先级）
├── H-2: 邮件服务集成
│   ├── H-2.1: mail_agent调度 - 通过routing_agent调度邮件任务
│   ├── H-2.2: 邮件模板管理 - 支持邮件模板的统一管理
│   ├── H-2.3: 发送状态跟踪 - 邮件发送状态的跟踪机制
│   └── H-2.4: 失败重试机制 - 邮件发送失败的重试策略
├── H-3: 邮件模板系统
│   ├── H-3.1: 模板结构
│   │   ├── H-3.1.1: base/ - 基础布局模板和通用样式文件
│   │   ├── H-3.1.2: auth/ - 验证码模板和密码重置模板
│   │   ├── H-3.1.3: notifications/ - 匹配通知模板和系统通知模板
│   │   └── H-3.1.4: marketing/ - 营销邮件模板
│   ├── H-3.2: 模板变量规范 - 验证码邮件变量、匹配通知邮件变量等
│   └── H-3.3: 多语言支持 - 中文模板(zh/)和英文模板(en/)
└── H-4: 队列管理系统
    ├── H-4.1: Redis队列架构
    │   ├── H-4.1.1: high_priority - mail:high（验证码、密码重置等）
    │   ├── H-4.1.2: normal_priority - mail:normal（通知、确认邮件等）
    │   ├── H-4.1.3: low_priority - mail:low（营销、推广邮件等）
    │   ├── H-4.1.4: retry_queue - mail:retry（失败重试队列）
    │   └── H-4.1.5: dead_letter - mail:failed（最终失败队列）
    └── H-4.2: 队列处理策略
        ├── H-4.2.1: 优先级处理 - 高优先级队列优先处理
        ├── H-4.2.2: 批量处理 - 批量取出邮件任务提高效率
        ├── H-4.2.3: 限流机制 - 根据服务商限制控制发送频率
        ├── H-4.2.4: 失败重试 - 指数退避重试策略（1分钟→5分钟→15分钟→1小时）
        └── H-4.2.5: 监控告警 - 队列堆积和处理失败的监控告警
```

------------------------------

### I: 状态管理

```
├── I-1: 邮件状态枚举
│   ├── I-1.1: PENDING - 待发送状态
│   ├── I-1.2: SENT - 已发送成功
│   ├── I-1.3: FAILED - 发送失败
│   ├── I-1.4: BOUNCED - 邮件被退回
│   └── I-1.5: DELIVERED - 确认送达
├── I-2: 核心数据字段定义
│   ├── I-2.1: 触发条件字段
│   │   ├── I-2.1.1: purchase_count - 被购买次数计数器（整数类型，≥0，触发阈值为10）
│   │   ├── I-2.1.2: deactivation_notified - 下架通知已发送标记（布尔类型，默认false）
│   │   ├── I-2.1.3: deactivation_timestamp - 下架时间戳（ISO8601格式，UTC时区）
│   │   └── I-2.1.4: notification_sent_at - 通知发送时间戳（ISO8601格式，UTC时区）
│   └── I-2.2: 模板变量字段
│       ├── I-2.2.1: user_name - 用户姓名变量（默认值: "用户"）
│       ├── I-2.2.2: total_views - 简历查看次数统计（默认值: 0）
│       ├── I-2.2.3: company_types - 感兴趣企业类型汇总（默认值: "多种行业"）
│       └── I-2.2.4: reactivation_link - 重新激活功能链接（必须字段，无默认值，缺失时报错）
└── I-3: 受影响的上下游字段联动
    ├── I-3.1: database_agent - purchase_count字段和email_delivery_status记录需同步
    ├── I-3.2: auth_agent - 用户邮箱验证状态与邮件发送结果需联动
    ├── I-3.3: matching_agent - 搜索计数触发邮件发送的条件判断需一致
    ├── I-3.4: frontend_service_agent - reactivation_link和用户界面状态需同步
    └── I-3.5: routing_agent - 邮件发送任务调度和状态管理配置需联动
```

------------------------------

### J: 日志与异常策略

```
├── J-1: 日志记录规范
│   ├── J-1.1: 日志框架 - 使用Python标准logging模块
│   ├── J-1.2: 必须记录的日志字段
│   │   ├── J-1.2.1: request_id - 请求唯一标识符
│   │   ├── J-1.2.2: agent_name - 固定值"mail_agent"
│   │   ├── J-1.2.3: operation - 操作类型(send_email, render_template, queue_process)
│   │   ├── J-1.2.4: email_type - 邮件类型枚举值
│   │   ├── J-1.2.5: recipient_masked - 脱敏后收件人（仅显示前3位+@+域名）
│   │   ├── J-1.2.6: smtp_provider - 实际使用的SMTP服务提供商
│   │   ├── J-1.2.7: delivery_status - 最终投递状态
│   │   ├── J-1.2.8: duration_ms - 操作耗时（毫秒）
│   │   └── J-1.2.9: retry_count - 重试次数
│   ├── J-1.3: 结构化日志 - JSON格式，包含邮件发送上下文信息
│   ├── J-1.4: 隐私保护 - 不记录邮件内容和敏感个人信息
│   └── J-1.5: 禁止事项 - 禁止使用print()进行任何输出
├── J-2: 异常处理规范
│   ├── J-2.1: 异常类型
│   │   ├── J-2.1.1: SMTPConnectionError - SMTP连接失败或超时
│   │   ├── J-2.1.2: EmailTemplateError - 邮件模板渲染失败
│   │   └── J-2.1.3: DeliveryFailureError - 邮件投递失败
│   ├── J-2.2: 向上传播 - 异常向routing_agent传播，提供详细的错误上下文
│   └── J-2.3: 用户友好 - 对用户屏蔽SMTP细节错误，保留完整日志记录
└── J-3: 敏感信息处理
    ├── J-3.1: 敏感信息脱敏 - 日志/错误信息不得包含密钥、令牌、身份证件、邮箱全量、手机号全量等
    ├── J-3.2: 秘钥管理 - 不得在代码/README/示例中出现任何真实秘钥
    └── J-3.3: 输入校验 - 所有外部输入必须显式校验（长度/类型/枚举/格式）
```

------------------------------

### K: UI组件结构

```
⚠️ 未定义 - mail_agent作为后端邮件服务模块，不涉及UI组件结构。邮件模板的HTML结构通过Jinja2模板引擎管理，但不属于前端UI组件范畴。
```

------------------------------

### L: 事件响应机制

```
├── L-1: 重大决策（业务逻辑）
│   ├── L-1.1: 购买计数触发决策
│   │   ├── L-1.1.1: 触发阈值 - purchase_count_trigger = 10（精确数值，不早不晚）
│   │   ├── L-1.1.2: 触发频次 - 每个简历生命周期仅触发一次，通过deactivation_notified标记防重复
│   │   ├── L-1.1.3: 通知语调 - 积极正面化，"恭喜备受关注"而非"限制措施"
│   │   └── L-1.1.4: 重新激活 - 一键重新激活，purchase_count重置为0，deactivation_notified重置为false
│   ├── L-1.2: 邮件发送决策（技术实现策略）
│   │   ├── L-1.2.1: 模板变量策略 - 所有变量必须有默认值，缺失时使用保守默认值
│   │   ├── L-1.2.2: 去重窗口策略 - dedup_window_hours = 24（24小时内同类型邮件不重复发送）
│   │   ├── L-1.2.3: 优先级策略 - verification_code_email (高) → system_notification (中) → marketing (低)
│   │   └── L-1.2.4: 重试策略 - 指数退避重试，retry_max_attempts = 3，间隔1分钟→5分钟→15分钟
│   ├── L-1.3: 队列处理决策（并发控制策略）
│   │   ├── L-1.3.1: 队列架构 - 三级优先级队列 + 重试队列 + 死信队列
│   │   ├── L-1.3.2: 并发模式 - 异步无状态处理，每个邮件任务独立完成
│   │   ├── L-1.3.3: 速率限制 - 遵守smtp_provider速率限制，避免服务商封禁
│   │   └── L-1.3.4: 故障转移 - 主SMTP故障时自动切换到备用服务商
│   └── L-1.4: SMTP服务商决策（可用性策略）
│       ├── L-1.4.1: 主服务商 - brevo作为主要smtp_provider
│       ├── L-1.4.2: 备用服务商 - aws_ses → sendgrid → aliyun按优先级故障转移
│       ├── L-1.4.3: 配置热更新 - 支持运行时配置更新，无需重启服务
│       └── L-1.4.4: 监控阈值 - 发送成功率 < 98%时触发告警
└── L-2: 事件处理流程
    ├── L-2.1: 简历下架通知邮件模板 - 购买次数达到上限通知，邮件类型resume_deactivation_notification
    ├── L-2.2: 认证验证码邮件模板 - 用户注册验证码邮件和密码重置验证码邮件
    └── L-2.3: 技术支持邮件模板 - 一键技术支持邮件生成，前端JavaScript复制到剪贴板
```

------------------------------

### M: 错误处理机制

```
├── M-1: 故障排查指南
│   ├── M-1.1: 常见问题解决
│   │   ├── M-1.1.1: 邮件发送失败 - 检查SMTP配置和网络连接
│   │   ├── M-1.1.2: 模板渲染错误 - 确认模板数据格式和必填字段
│   │   └── M-1.1.3: 队列堆积严重 - 检查Redis连接和处理器状态
│   ├── M-1.2: 快速诊断命令
│   │   ├── M-1.2.1: 检查邮件服务状态 - curl http://localhost:8000/agents/mail_agent/health
│   │   ├── M-1.2.2: 查看邮件队列状态 - redis-cli LLEN mail:high/normal
│   │   └── M-1.2.3: 检查最近邮件发送日志 - tail -f logs/mail_agent.log | grep "MAIL_"
│   └── M-1.3: 异常处理
│       ├── M-1.3.1: 网络异常 - SMTP连接失败的处理
│       ├── M-1.3.2: 服务商限制 - 超出发送限制的处理
│       ├── M-1.3.3: 模板错误 - 模板渲染失败的处理
│       └── M-1.3.4: 数据异常 - 收件人地址无效的处理
└── M-2: 监控与统计
    ├── M-2.1: 关键指标
    │   ├── M-2.1.1: 发送成功率 - 邮件发送成功的百分比
    │   ├── M-2.1.2: 投递率 - 邮件成功到达收件箱的百分比
    │   ├── M-2.1.3: 退信率 - 邮件被退回的百分比
    │   ├── M-2.1.4: 打开率 - 邮件被打开的百分比（支持跟踪的邮件）
    │   └── M-2.1.5: 点击率 - 邮件中链接被点击的百分比
    └── M-2.2: 日志记录格式 - 包含timestamp、request_id、mail_type、recipient、status、provider等字段
```

------------------------------

### N: WebSocket集成接口

```
⚠️ 未定义 - mail_agent作为邮件服务模块，主要通过SMTP协议发送邮件，不涉及WebSocket集成接口。邮件发送状态的实时通知可能通过其他模块的WebSocket连接实现，但不在mail_agent的职责范围内。
```

------------------------------

### O: LLM集成机制

```
├── O-1: LLM调用规范
│   ├── O-1.1: 特殊说明 - 邮件模板基于预配置模板，通常无需LLM调用
│   ├── O-1.2: 可选用途 - 仅在个性化邮件内容生成时使用LLM
│   ├── O-1.3: 调用方式 - 通过await routing_agent.call_agent("llm_handler_agent", payload)
│   ├── O-1.4: 严禁事项 - 直接访问OpenAI、Claude、Gemini等API
│   └── O-1.5: 模型要求 - 强制使用gpt-4o-2024-08-06
└── O-2: 使用场景
    └── O-2.1: 个性化邮件内容生成 - 在需要动态生成个性化邮件内容时调用LLM服务
```

------------------------------

### P: 上传机制

```
⚠️ 未定义 - mail_agent作为邮件服务模块，不涉及文件上传机制。邮件附件的处理可能需要在未来版本中考虑，但当前版本主要专注于文本和HTML邮件的发送。
```

------------------------------

### Q: 环境配置

```
├── Q-1: Python环境规范
│   ├── Q-1.1: Python版本 - Python 3.10+（强制）
│   ├── Q-1.2: 运行环境 - 支持asyncio异步并发处理
│   ├── Q-1.3: 依赖管理 - 使用requirements.txt管理依赖版本
│   └── Q-1.4: 资源要求 - 内存384MB+，CPU 1核+
├── Q-2: Pydantic V2规范
│   ├── Q-2.1: 必须使用 - model_validate()、model_dump()、Field()、BaseModel
│   ├── Q-2.2: 严禁使用 - .dict()、.parse_obj()、.json()、parse_obj_as()
│   ├── Q-2.3: 字段验证 - 必须使用pattern=r"regex"，严禁使用regex=r"regex"
│   └── Q-2.4: 模型导入 - 统一从global_schemas导入，禁止本地重复定义
├── Q-3: 异步处理规范
│   ├── Q-3.1: 必须要求 - 所有邮件发送和队列处理方法使用async def
│   ├── Q-3.2: 禁止事项 - 同步阻塞操作、threading、multiprocessing
│   └── Q-3.3: 并发处理 - 使用asyncio.create_task()、asyncio.gather()处理并发邮件发送
└── Q-4: 部署规范
    ├── Q-4.1: 环境要求 - Python 3.10+，内存384MB+，CPU 1核+
    ├── Q-4.2: 依赖服务 - routing_agent、global_config、SMTP服务商
    ├── Q-4.3: 监控指标 - 邮件发送成功率 > 98%，响应时间 < 5秒，队列处理能力 1000+邮件/小时
    └── Q-4.4: 健康检查 - SMTP连通性验证、模板加载检查、队列状态监控
```

------------------------------

### R: 运行要求

```
├── R-1: 核心依赖
│   ├── R-1.1: smtplib - 邮件发送
│   ├── R-1.2: jinja2>=3.0.0 - 模板渲染
│   ├── R-1.3: redis>=4.0.0 - 队列管理
│   └── R-1.4: asyncio - 异步处理
├── R-2: Agent依赖
│   ├── R-2.1: routing_agent - 调度中心
│   └── R-2.2: database_agent - 状态存储
├── R-3: 外部服务
│   ├── R-3.1: SMTP服务器 - 邮件发送服务
│   └── R-3.2: Redis队列服务 - 邮件队列管理
├── R-4: 运行环境
│   ├── R-4.1: Python 3.10+ - 基础运行环境
│   └── R-4.2: 256MB+ 内存 - 最小内存要求
└── R-5: 最小启动命令
    └── R-5.1: python main.py --start - 系统启动命令
```

------------------------------

### S: 版本依赖

```
├── S-1: 技术规范遵循
│   ├── S-1.1: 核心约束
│   │   ├── S-1.1.1: Pydantic V2 - 使用model_validate()和model_dump()，禁用V1方法
│   │   ├── S-1.1.2: 字段验证 - 使用pattern替代regex
│   │   ├── S-1.1.3: 异步处理 - 所有函数使用async def，支持批量邮件发送
│   │   ├── S-1.1.4: 配置驱动 - SMTP配置通过routing_agent从global_config获取
│   │   └── S-1.1.5: 数据格式 - 输入输出严格遵循AgentRequest和AgentResponse
│   ├── S-1.2: 架构约束
│   │   ├── S-1.2.1: 被动调用 - 模块不主动运行，仅响应中枢调度
│   │   ├── S-1.2.2: 无状态设计 - 每次调用独立完成，不保存上下文
│   │   ├── S-1.2.3: 中枢调度 - 与其他模块的交互统一通过routing_agent
│   │   └── S-1.2.4: 统一入口 - 仅暴露run()方法作为唯一接口
│   └── S-1.3: 特殊约束
│       ├── S-1.3.1: 邮件服务职责 - 承担系统邮件通信核心职责
│       ├── S-1.3.2: 模板管理 - 邮件模板通过routing_agent获取，禁止硬编码内容
│       ├── S-1.3.3: 安全约束 - 敏感信息加密传输，垃圾邮件防护，隐私合规
│       └── S-1.3.4: 质量控制 - 严禁Mock机制，必须真实发送或明确失败
└── S-2: 版本兼容性
    └── S-2.1: 配置版本管理 - 任何新增/变更字段必须标注语义、默认值、兼容策略，并同步更新global_schemas对应版本
```

------------------------------

### T: 模块限制

```
├── T-1: 开发边界限制
│   ├── T-1.1: 术语与名词表统一定义
│   │   ├── T-1.1.1: 邮件代理模块 - mail_agent（统一术语，全文使用此叫法）
│   │   ├── T-1.1.2: 简历下架通知 - resume_deactivation_notification（统一邮件类型标识）
│   │   ├── T-1.1.3: 购买计数触发 - purchase_count_trigger（统一触发机制叫法）
│   │   ├── T-1.1.4: 邮件发送状态 - email_delivery_status（统一状态追踪术语）
│   │   ├── T-1.1.5: 邮件服务提供商 - smtp_provider（统一服务商术语）
│   │   └── T-1.1.6: 验证码邮件 - verification_code_email（统一验证类邮件术语）
│   ├── T-1.2: 技术术语统一
│   │   ├── T-1.2.1: 配置获取方式 - 统一通过routing_agent.get_config()获取
│   │   ├── T-1.2.2: 数据模型来源 - 统一从global_schemas模块导入
│   │   └── T-1.2.3: 状态存储方式 - 统一通过database_agent进行持久化
│   └── T-1.3: 适用范围与角色
│       ├── T-1.3.1: 目标 - 限制自动化生成在文件创建/编辑/依赖方向/接口契约四个维度的自由度
│       └── T-1.3.2: 占位符映射 - MODULE_NAME: mail_agent, MODULE_ROOT: applications/mail_agent/
├── T-2: 目录与文件边界
│   ├── T-2.1: 工作区限制 - 生成和修改仅允许发生在applications/mail_agent/内
│   ├── T-2.2: 主入口约定 - 模块主入口文件名与mail_agent同名
│   ├── T-2.3: 粒度限制 - 单次变更仅允许操作一个文件；若超过300行，自动截断
│   └── T-2.4: 结构稳定性 - 禁止因实现便利而新建"公共"目录
├── T-3: 职责分层边界
│   ├── T-3.1: Main（主文件） - 只做策略选择、依赖装配、流程编排
│   ├── T-3.2: Adapter（适配层） - 只实现外设与机制（HTTP/DB/Cache/Queue/FS/LLM调用等）
│   ├── T-3.3: Aux（私有实现） - 仅供Main/Adapter内部复用
│   └── T-3.4: 拆分触发 - 当单文件同时承担两类以上变更原因或超过200行时必须拆分
├── T-4: 契约与模型来源
│   ├── T-4.1: 模型唯一来源 - 所有数据模型/Schema一律从global_schemas引入
│   ├── T-4.2: 接口契约 - 本模块README必须提供最小可执行契约
│   └── T-4.3: 版本与兼容 - 任何新增/变更字段必须在README标注语义、默认值、兼容策略
├── T-5: 配置与特性开关
│   ├── T-5.1: 配置唯一来源 - 配置仅可经由routing_agent的config_manager服务读取
│   └── T-5.2: 热更新与回滚 - 配置键名/层级不可私改；新增键必须提供默认值、回滚策略
├── T-6: 外部I/O与状态
│   ├── T-6.1: 状态存取 - 模块不得直接访问持久化，必须通过指定Adapter间接访问
│   ├── T-6.2: 副作用隔离 - 任何网络/系统I/O仅可写在Adapter
│   └── T-6.3: 可重复执行 - 生成的任意函数需满足幂等/可重放要求
├── T-7: 并发与资源
│   ├── T-7.1: 并发原语 - 仅允许使用语言原生异步原语，禁止线程池/进程池
│   └── T-7.2: 超时与重试 - 必须经routing_agent的config_manager服务注入
├── T-8: 观测与审计
│   ├── T-8.1: 日志必填字段 - request_id、module_name、operation、duration_ms、success、retry_count
│   ├── T-8.2: 敏感信息 - 日志/错误信息不得包含密钥、令牌、身份证件、邮箱全量、手机号全量等
│   └── T-8.3: 指标 - 至少暴露调用次数、成功率、时延分布三类指标
├── T-9: 错误与返回
│   ├── T-9.1: 错误码规范 - 采用{DOMAIN}/{REASON}命名
│   ├── T-9.2: 异常传播 - 只允许抛出仓库标准异常基类及其子类
│   └── T-9.3: 失败回退 - 失败时必须返回可操作指令
├── T-10: 安全与合规
│   ├── T-10.1: 秘钥管理 - 不得在代码/README/示例中出现任何真实秘钥
│   ├── T-10.2: 输入校验 - 所有外部输入必须显式校验
│   └── T-10.3: 权限与最小化 - 模块内不得提升权限
├── T-11: 测试与验收
│   ├── T-11.1: 最小用例 - 本模块至少提供冒烟链路与失败路径两类用例
│   └── T-11.2: 验收门槛 - 生成变更必须先通过本模块用例再提交
├── T-12: 生成器执行规范
│   ├── T-12.1: 部分修改优先 - 每次仅修改一个文件，≤300行
│   ├── T-12.2: 禁止脑补 - 遇到缺失信息，停止输出并在README的"待补要点"清单中列明
│   ├── T-12.3: 依赖单向 - Domain → Adapter单向依赖
│   ├── T-12.4: 不迁移/不重命名/不删除 - 除非README的"迁移方案"明确列出变更映射
│   └── T-12.5: 不新增公共层 - 任何"utils/common/shared"目录新增一律拒绝
├── T-13: 关键词黑名单
│   ├── T-13.1: 禁止本地业务模型定义 - "class .*Model", "data class .*", "interface .*DTO"
│   ├── T-13.2: 禁止硬编码配置 - "API_KEY=", "timeout\\s*=\\s*\\d+", "retry\\s*=\\s*\\d+"
│   ├── T-13.3: 禁止跨层I/O - 在Main/Aux中出现"http", "db", "sql", "open(", "requests", "fetch"
│   ├── T-13.4: 禁止并发越界 - "Thread", "Process", "fork", "Pool"
│   └── T-13.5: 禁止未脱敏日志 - "print(", "console.log(", "logging.info(f\\".*password|token|secret"
└── T-14: "待补要点"机制
    └── T-14.1: 必要说明 - 遇到字段未定义、路径不明、错误码缺失、指标未命名等情况，生成器不得继续实现，必须在README的"待补要点"清单中列出
```

------------------------------

### U: 测试策略

```
├── U-1: 测试规范约束
│   ├── U-1.1: 生产级测试 - 使用真实的SMTP服务进行邮件发送测试
│   ├── U-1.2: 完整流程 - 测试模板渲染→队列处理→SMTP发送→状态跟踪的完整链路
│   └── U-1.3: 多服务商测试 - 验证多个SMTP服务商的集成和切换
├── U-2: 测试环境邮件处理机制
│   ├── U-2.1: 测试邮件拦截与验证码提取
│   │   ├── U-2.1.1: 测试模式邮件拦截机制 - 激活条件ENV=test环境变量 + 收件人邮箱包含@test.域名
│   │   ├── U-2.1.2: 安全限制 - 仅拦截测试域名邮件，生产邮件正常发送
│   │   ├── U-2.1.3: 测试邮件拦截处理流程 - 识别发送给测试邮箱的邮件、提取验证码内容、存储至Redis临时缓存、阻止实际邮件发送
│   │   └── U-2.1.4: 测试验证码提取API接口 - 测试专用获取指定邮箱的验证码，供E2E测试脚本调用
│   └── U-2.2: 测试邮件域名管理
│       ├── U-2.2.1: 测试邮箱识别规则 - 包含@test.、@e2e.、@local.、@example.com域名
│       └── U-2.2.2: 验证码提取规则 - 从邮件内容中提取6位验证码，支持多种验证码格式
└── U-3: 测试用例要求
    ├── U-3.1: 完整邮件发送流程测试 - 测试从请求接收到邮件发送完成的完整流程
    └── U-3.2: SMTP故障转移机制测试 - 测试主SMTP服务商故障时的自动切换机制
```

------------------------------

### V: 验收机制

```
├── V-1: 性能指标规范
│   ├── V-1.1: 必须暴露的稳定指标
│   │   ├── V-1.1.1: mail_agent_requests_total - 调用量指标（计数器，按邮件类型分维度）
│   │   ├── V-1.1.2: mail_agent_success_rate - 成功率指标（百分比，最近1小时滑动窗口）
│   │   ├── V-1.1.3: mail_agent_send_duration_seconds - 发送耗时指标（直方图，P50/P95/P99分位数）
│   │   ├── V-1.1.4: mail_agent_smtp_connections_total - SMTP连接指标（计数器，按服务商分维度）
│   │   └── V-1.1.5: mail_agent_queue_depth - 队列堆积指标（仪表盘，按优先级分维度）
│   └── V-1.2: 必须暴露的指标
│       ├── V-1.2.1: mail_agent_requests_total - 调用次数
│       ├── V-1.2.2: mail_agent_success_rate - 成功率
│       ├── V-1.2.3: mail_agent_duration_seconds - 时延分布
│       ├── V-1.2.4: mail_send_success_rate - 邮件发送成功率
│       ├── V-1.2.5: mail_smtp_connection_success_rate - SMTP连接成功率
│       └── V-1.2.6: mail_queue_processing_rate - 队列处理速度
└── V-2: 验收标准
    ├── V-2.1: 邮件发送成功率 - > 98%
    ├── V-2.2: 响应时间 - < 5秒
    └── V-2.3: 队列处理能力 - 1000+邮件/小时
```

------------------------------

### W: 部署策略

```
⚠️ 未定义 - 具体的部署策略需要结合整体系统架构和运维要求进行定义。当前仅明确了基本的环境要求和依赖服务，详细的部署流程、容器化配置、负载均衡等策略有待补充。
```

------------------------------

### X: 未来规划

```
⚠️ 未定义 - 邮件服务的未来规划和功能扩展计划有待产品和技术团队进一步讨论确定。可能包括邮件附件支持、高级模板功能、邮件分析统计等功能的规划。
```

------------------------------

### Y: 未定义项

```
├── Y-1: 配置键值待补充（影响模块启动）
│   ├── Y-1.1: SMTP密码配置键
│   │   ├── Y-1.1.1: 待补键名 - mail_agent.smtp_providers.brevo.password_key
│   │   ├── Y-1.1.2: 建议选项 - "BREVO_SMTP_PASSWORD" / "MAIL_SERVICE_PASSWORD" / "SMTP_AUTH_TOKEN"
│   │   └── Y-1.1.3: 影响面 - 邮件发送功能完全不可用，所有邮件发送失败
│   ├── Y-1.2: 支持邮箱配置键
│   │   ├── Y-1.2.1: 待补键名 - mail_agent.technical_support_email
│   │   ├── Y-1.2.2: 建议选项 - "support@4waysgroup.com" / "tech-support@4waysgroup.com" / "help@4waysgroup.com"
│   │   └── Y-1.2.3: 影响面 - 技术支持邮件模板无法生成，用户求助功能受限
│   └── Y-1.3: Redis连接配置
│       ├── Y-1.3.1: 待补键名 - mail_agent.redis_connection_config
│       ├── Y-1.3.2: 建议选项 - 独立Redis实例 / 共享Redis实例 / 内存队列回退
│       └── Y-1.3.3: 影响面 - 邮件队列功能不可用，所有邮件发送变为同步阻塞
└── Y-2: 业务规则待明确（影响处理逻辑）
    ├── Y-2.1: 重新激活链接有效期
    │   ├── Y-2.1.1: 待补数值 - reactivation_link_expiry_hours
    │   ├── Y-2.1.2: 建议选项 - 24小时 / 48小时 / 7天
    │   └── Y-2.1.3: 保守处理 - 24小时过期，过期后需重新生成
    └── Y-2.2: 技术支持邮件发送方式
        ├── Y-2.2.1: 待补策略 - 系统代发 vs 用户自发
        ├── Y-2.2.2: 建议选项 - 系统自动发送 / 生成模板用户复制 / 混合模式
        └── Y-2.2.3: 保守处理 - 生成模板到剪贴板，用户手动发送
```

------------------------------

### Z: 待补要点

```
├── Z-1: 配置项待补充
│   ├── Z-1.1: SMTP密码配置键 - 影响邮件发送功能完全不可用
│   ├── Z-1.2: 技术支持邮箱配置 - 影响用户求助功能受限
│   └── Z-1.3: Redis连接配置 - 影响邮件队列功能不可用
├── Z-2: 业务规则待明确
│   ├── Z-2.1: 重新激活链接有效期 - 影响用户体验和安全性
│   └── Z-2.2: 技术支持邮件发送方式 - 影响用户问题反馈流程
├── Z-3: 技术实现待定义
│   ├── Z-3.1: 部署策略 - 容器化配置、负载均衡等策略
│   ├── Z-3.2: 未来规划 - 邮件附件支持、高级模板功能等
│   └── Z-3.3: UI组件结构 - mail_agent不涉及UI组件
└── Z-4: 集成接口待补充
    ├── Z-4.1: WebSocket集成接口 - mail_agent不涉及WebSocket集成
    ├── Z-4.2: 上传机制 - mail_agent不涉及文件上传机制
    └── Z-4.3: 意图识别机制 - mail_agent不涉及复杂的意图识别机制
```

------------------------------

### AA: 黑名单规则

```
├── AA-1: 关键词黑名单（检测红线）
│   ├── AA-1.1: 禁止本地业务模型定义 - "class .*Model", "data class .*", "interface .*DTO"
│   ├── AA-1.2: 禁止硬编码配置 - "API_KEY=", "timeout\\s*=\\s*\\d+", "retry\\s*=\\s*\\d+"
│   ├── AA-1.3: 禁止跨层I/O - 在Main/Aux中出现"http", "db", "sql", "open(", "requests", "fetch"
│   ├── AA-1.4: 禁止并发越界 - "Thread", "Process", "fork", "Pool"
│   └── AA-1.5: 禁止未脱敏日志 - "print(", "console.log(", "logging.info(f\\".*password|token|secret"
├── AA-2: 严禁使用的方法
│   ├── AA-2.1: Pydantic V1方法 - .dict()、.parse_obj()、.json()、parse_obj_as()
│   ├── AA-2.2: 同步阻塞操作 - threading、multiprocessing
│   └── AA-2.3: 直接API访问 - 直接访问OpenAI、Claude、Gemini等API
└── AA-3: 禁用规则
    ├── AA-3.1: Mock机制 - 严禁Mock机制，必须真实发送或明确失败
    ├── AA-3.2: 硬编码内容 - 邮件模板禁止硬编码，必须通过routing_agent获取
    └── AA-3.3: 权限提升 - 模块内不得提升权限，仅请求所需最小范围的权限
```

------------------------------

### BB: 禁用规则

```
├── BB-1: 开发边界禁用规则
│   ├── BB-1.1: 文件系统限制 - 禁止创建、移动、重命名、删除applications/mail_agent/之外的任何文件/目录
│   ├── BB-1.2: 业务规则限制 - 禁止任何业务规则、存储访问、外部I/O在Main文件中
│   ├── BB-1.3: 跨模块限制 - 不得跨模块导出，禁止出现横向依赖
│   └── BB-1.4: 配置限制 - 禁止本地硬编码可变配置，禁止直接读取环境变量
├── BB-2: 技术实现禁用规则
│   ├── BB-2.1: 同步操作禁用 - 禁止同步阻塞操作、threading、multiprocessing
│   ├── BB-2.2: 直接I/O禁用 - Main/Aux出现I/O视为违规
│   ├── BB-2.3: 线程池禁用 - 禁止线程池/进程池，除非在Adapter层且README明示风险
│   └── BB-2.4: 裸异常禁用 - 不得抛裸异常，只允许抛出仓库标准异常基类及其子类
├── BB-3: 安全合规禁用规则
│   ├── BB-3.1: 真实秘钥禁用 - 不得在代码/README/示例中出现任何真实秘钥
│   ├── BB-3.2: 敏感信息禁用 - 日志/错误信息不得包含密钥、令牌、身份证件等敏感信息
│   └── BB-3.3: 权限提升禁用 - 模块内不得提升权限，仅请求所需最小范围的权限
└── BB-4: 生成器行为禁用规则
    ├── BB-4.1: 脑补禁用 - 遇到缺失信息，停止输出并在README的"待补要点"清单中列明，不得擅自发明
    ├── BB-4.2: 反向引用禁用 - 生成器如果检测到反向引用，直接终止
    ├── BB-4.3: 迁移禁用 - 不迁移/不重命名/不删除，除非README的"迁移方案"明确列出变更映射
    └── BB-4.4: 公共层禁用 - 任何"utils/common/shared"目录新增一律拒绝
```
